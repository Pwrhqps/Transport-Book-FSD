@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using System.Security.Claims
@inject NavigationManager Nav

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">Transport-Book-FSD</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">

        <AuthorizeView Context="auth">

            <NotAuthorized>
                <!-- Only show Home when NOT logged in -->
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                        <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Home
                    </NavLink>
                </div>

                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="auth/login">
                        <span class="bi bi-box-arrow-in-right" aria-hidden="true"></span> Login
                    </NavLink>
                </div>

                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="auth/register">
                        <span class="bi bi-person-plus" aria-hidden="true"></span> Register
                    </NavLink>
                </div>
            </NotAuthorized>

            <Authorized>
                @{
                    var rel = Nav.ToBaseRelativePath(Nav.Uri);

                    var isStaffVerify =
                    rel.Contains("staff", StringComparison.OrdinalIgnoreCase)
                    && (
                    rel.Contains("verify", StringComparison.OrdinalIgnoreCase)
                    || rel.Contains("verification", StringComparison.OrdinalIgnoreCase)
                    || rel.Contains("otp", StringComparison.OrdinalIgnoreCase)
                    || rel.Contains("2fa", StringComparison.OrdinalIgnoreCase)
                    );

                    var email = auth.User.FindFirst(ClaimTypes.Email)?.Value
                    ?? auth.User.Identity?.Name
                    ?? "";
                }


                @if (isStaffVerify)
                {
                    <!-- Force public menu during OTP verification -->
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                            Home
                        </NavLink>
                    </div>

                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="auth/login">
                            Login
                        </NavLink>
                    </div>

                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="auth/register">
                            Register
                        </NavLink>
                    </div>
                }
                else
                {
                    @* ===== NORMAL AUTHENTICATED MENUS ===== *@

                    @if (auth.User.IsInRole("Passenger"))
                    {
                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="passenger/home">Passenger Home</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="passenger/profile">My Profile</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="passenger/book">My Bookings</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="passenger/mybookings">Bookings History</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="passenger/feedback/7">Feedback</NavLink>
                        </div>


                    }

                    @if (auth.User.IsInRole("Driver"))
                    {
                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="driver/home">Driver Home</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="driver/profile">My Profile</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="driver/jobs">Available Jobs</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="driver/myjobs">My Jobs</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="driver/feedbacks">My Feedbacks</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="driver/vehicles">Rent A Vehicle</NavLink>
                        </div>

                    }

                    @if (auth.User.IsInRole("Staff"))
                    {
                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="staff/home">Staff Dashboard</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="staff/manageusers">Manage Users</NavLink>
                        </div>

                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="staff/verifydrivers">Verify Drivers</NavLink>
                        </div>
                        
                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="staff/driverfeedbacks">Driver Feedbacks</NavLink>
                        </div>
                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="staff/vehicles">Vehicle Creation</NavLink>
                        </div>

                    }

                    <div class="nav-item px-3">
                        <div class="nav-link" style="cursor: default;">
                            @email
                        </div>
                    </div>

                    <div class="nav-item px-3">
                        <form method="post" action="/auth/logout">
                            <button type="submit" class="nav-link btn btn-link">Logout</button>
                        </form>
                    </div>
                }
            </Authorized>


        </AuthorizeView>

    </nav>
</div>
