@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using TransportBookFSD.Data
@using TransportBookFSD.Models

@inject NavigationManager Nav
@inject AuthenticationStateProvider authStateProvider
@inject IServiceScopeFactory ScopeFactory

@implements IDisposable

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">Transport-Book-FSD</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">

        <AuthorizeView Context="auth">

            <NotAuthorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                        Home
                    </NavLink>
                </div>

                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="auth/login">
                        Login
                    </NavLink>
                </div>

                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="auth/register">
                        Register
                    </NavLink>
                </div>
            </NotAuthorized>

            <Authorized>
                @{
                    var email = auth.User.FindFirst(ClaimTypes.Email)?.Value
                    ?? auth.User.Identity?.Name
                    ?? "";
                }

                @* ===== PASSENGER ===== *@
                @if (auth.User.IsInRole("Passenger"))
                {
                    <div class="nav-item px-3"><NavLink class="nav-link" href="passenger/home">Passenger Home</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="passenger/profile">My Profile</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="passenger/book">Book a Ride</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="passenger/mybookings">My Bookings</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="passenger/bookinghistory">History and Feedback</NavLink></div>

                    <div class="nav-item px-3">
                        <div class="nav-link" style="cursor: default;">@email</div>
                    </div>

                    <div class="nav-item px-3">
                        <form method="post" action="/auth/logout">
                            <button type="submit" class="nav-link btn btn-link">Logout</button>
                        </form>
                    </div>
                }

                @* ===== DRIVER ===== *@
                @if (auth.User.IsInRole("Driver"))
                {
                    <div class="nav-item px-3"><NavLink class="nav-link" href="driver/home">Driver Home</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="driver/profile">My Profile</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="driver/jobs">Available Jobs</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="driver/myjobs">My Jobs</NavLink></div>

                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="driver/pending-cash">
                            Pending Cash
                            @if (pendingCashCount > 0)
                            {
                                <span class="badge bg-danger ms-2">@pendingCashCount</span>
                            }
                        </NavLink>
                    </div>

                    <div class="nav-item px-3"><NavLink class="nav-link" href="driver/feedbacks">My Feedbacks</NavLink></div>
                    <div class="nav-item px-3"><NavLink class="nav-link" href="driver/vehicles">Rent A Vehicle</NavLink></div>

                    <div class="nav-item px-3">
                        <div class="nav-link" style="cursor: default;">@email</div>
                    </div>

                    <div class="nav-item px-3">
                        <form method="post" action="/auth/logout">
                            <button type="submit" class="nav-link btn btn-link">Logout</button>
                        </form>
                    </div>
                }

                @* ===== STAFF ===== *@
                @if (auth.User.IsInRole("Staff"))
                {
                    @*Only show Staff menu after OTP verification (Policy Staff2FA) *@
                    <AuthorizeView Policy="Staff2FA">
                        <NotAuthorized>
                            @* Show the same menu as login page *@
                            <div class="nav-item px-3">
                                <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                                    Home
                                </NavLink>
                            </div>

                            <div class="nav-item px-3">
                                <NavLink class="nav-link" href="auth/login">
                                    Login
                                </NavLink>
                            </div>

                            <div class="nav-item px-3">
                                <NavLink class="nav-link" href="auth/register">
                                    Register
                                </NavLink>
                            </div>

                            <div class="nav-item px-3">
                                <div class="nav-link" style="cursor: default;">@email</div>
                            </div>

                            <div class="nav-item px-3">
                                <form method="post" action="/auth/logout">
                                    <button type="submit" class="nav-link btn btn-link">Logout</button>
                                </form>
                            </div>
                        </NotAuthorized>

                        <Authorized>
                            <div class="nav-item px-3"><NavLink class="nav-link" href="staff/home">Staff Dashboard</NavLink></div>
                            <div class="nav-item px-3"><NavLink class="nav-link" href="staff/manageusers">Manage Users</NavLink></div>
                            <div class="nav-item px-3"><NavLink class="nav-link" href="staff/verifydrivers">Verify Drivers</NavLink></div>
                            <div class="nav-item px-3"><NavLink class="nav-link" href="staff/driverfeedbacks">Driver Feedbacks</NavLink></div>
                            <div class="nav-item px-3"><NavLink class="nav-link" href="staff/vehicles">Vehicle Creation</NavLink></div>

                            <div class="nav-item px-3">
                                <div class="nav-link" style="cursor: default;">@email</div>
                            </div>

                            <div class="nav-item px-3">
                                <form method="post" action="/auth/logout">
                                    <button type="submit" class="nav-link btn btn-link">Logout</button>
                                </form>
                            </div>
                        </Authorized>
                    </AuthorizeView>
                }
            </Authorized>

        </AuthorizeView>

    </nav>
</div>

@code {
    private int pendingCashCount = 0;

    protected override async Task OnInitializedAsync()
    {
        Nav.LocationChanged += OnLocationChanged;
        await RefreshPendingCashCount();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await RefreshPendingCashCount();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshPendingCashCount()
    {
        pendingCashCount = 0;

        var state = await authStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (user?.Identity?.IsAuthenticated != true) return;
        if (!user.IsInRole("Driver")) return;

        var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);
        if (string.IsNullOrWhiteSpace(userId)) return;

        //Use scope to get AppDbContext
        using var scope = ScopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();

        pendingCashCount = await db.Bookings
            .Include(b => b.Payment)
            .CountAsync(b =>
                b.DriverUserId == userId
                && !b.IsPaid
                && b.Payment != null
                && b.Payment.Method == "Cash"
                && b.Payment.Status == Payment.PaymentStatuses.Pending
            );
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}
