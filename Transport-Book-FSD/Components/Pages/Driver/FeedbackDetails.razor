@page "/driver/feedback/{BookingId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Driver")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<style>
    .star {
        font-size: 24px;
        color: #f5c518;
        margin-right: 2px;
    }

        .star.empty {
            color: #ccc;
        }
</style>

<h3>Feedback</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading...</p>
}
else if (booking == null)
{
    <p>Booking not found.</p>
    <button class="btn btn-outline-dark" @onclick="Back">Back</button>
}
else
{
    <div class="card">
        <div class="card-header fw-bold">
            Booking #@booking.BookingId
        </div>

        <div class="card-body">

            <div class="mb-3">
                <div class="fw-bold mb-1">Customer Details</div>
                <div><b>Name:</b> @customerName</div>
                <div><b>Contact:</b> @customerPhone</div>
            </div>

            <hr />

            <div class="mb-2"><b>Pickup:</b> @booking.PickupLocation</div>
            <div class="mb-2"><b>Dropoff:</b> @booking.DropoffLocation</div>
            <div class="mb-2"><b>Pickup Time:</b> @booking.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="mb-2"><b>Status:</b> @booking.Status</div>

            <hr />

            @if (feedback == null)
            {
                <p>No feedback submitted for this booking.</p>
            }
            else
            {
                <div class="mb-2">
                    <b>Rating:</b>
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= feedback.Rating)
                        {
                            <span class="star">★</span>
                        }
                        else
                        {
                            <span class="star empty">★</span>
                        }
                    }
                </div>

                <div class="mb-2"><b>Comment:</b> @(string.IsNullOrWhiteSpace(feedback.Comment) ? "-" : feedback.Comment)</div>
                <div class="mb-2"><b>Submitted At:</b> @feedback.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
            }

            <hr />

            <button class="btn btn-outline-dark" @onclick="Back">Back</button>
        </div>
    </div>
}

@code {
    [Parameter] public int BookingId { get; set; }

    private bool isLoading = true;
    private string? msg;

    private Booking? booking;
    private Feedback? feedback;

    private string customerName = "-";
    private string customerPhone = "-";

    // Retrieves the currently logged-in user.
    private async Task<ApplicationUser?> GetCurrentUser()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        return await userManager.GetUserAsync(authState.User);
    }

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    // Loads booking, customer details, and feedback from the database.
    private async Task Load()
    {
        isLoading = true;
        msg = null;

        customerName = "-";
        customerPhone = "-";
        booking = null;
        feedback = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            isLoading = false;
            return;
        }

        // Only allow the correct driver to access this booking
        booking = db.Bookings.FirstOrDefault(b =>
            b.BookingId == BookingId &&
            b.DriverUserId == user.Id
        );

        if (booking == null)
        {
            isLoading = false;
            return;
        }

        // Load customer details from PassengerProfile
        if (!string.IsNullOrWhiteSpace(booking.PassengerUserId))
        {
            var pp = db.PassengerProfiles.FirstOrDefault(p => p.UserId == booking.PassengerUserId);
            if (pp != null)
            {
                customerName = string.IsNullOrWhiteSpace(pp.FullName) ? "-" : pp.FullName;
                customerPhone = string.IsNullOrWhiteSpace(pp.ContactNumber) ? "-" : pp.ContactNumber;
            }
        }

        // Fallback: load from Identity user email if PassengerProfile name is not available
        // Use the passenger’s email as a backup “name”
        if (customerName == "-" && !string.IsNullOrWhiteSpace(booking.PassengerUserId))
        {
            var passengerUser = await userManager.FindByIdAsync(booking.PassengerUserId);
            if (passengerUser != null)
            {
                customerName = string.IsNullOrWhiteSpace(passengerUser.Email) ? "-" : passengerUser.Email;
            }
        }
        // Load feedback for this booking
        feedback = db.Feedbacks.FirstOrDefault(f => f.BookingId == booking.BookingId);

        isLoading = false;
    }
    // Redirects to the driver feedbacks page.
    private void Back()
    {
        nav.NavigateTo("/driver/feedbacks");
    }
}
