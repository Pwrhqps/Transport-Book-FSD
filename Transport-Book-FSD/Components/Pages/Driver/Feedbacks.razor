@page "/driver/feedbacks"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Driver")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>Feedback</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading feedback...</p>
}
else if (items.Count == 0)
{
    <p>No feedback received yet.</p>
}
else
{
    <div class="mb-3">
        <b>Average Rating:</b> @avgRating.ToString("0.0") @GetStars((int)Math.Round(avgRating))
        <span class="text-muted">(@items.Count feedback)</span>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Pickup</th>
                <th>Dropoff</th>
                <th>Pickup Time</th>
                <th>Passenger</th>
                <th>Submitted At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @{
                int row = 1;
            }
            @foreach (var x in items)
            {
                <tr>
                    <td>@row</td>
                    <td>@x.Pickup</td>
                    <td>@x.Dropoff</td>
                    <td>@x.PickupTime.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@(string.IsNullOrEmpty(x.PassengerName) ? "-" : x.PassengerName)</td>
                    <td>@x.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        <button class="btn btn-sm btn-outline-dark" @onclick="() => ViewJob(x.BookingId)">
                            View
                        </button>
                    </td>
                </tr>
                row++;
            }
        </tbody>
    </table>
}

@* Variables used to manage page state and display feedback information*@
@code {
    private bool isLoading = true;
    private string? msg;

    private List<FeedbackRow> items = new();
    private double avgRating = 0;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {   
        // Reset page state before loading
        isLoading = true;
        msg = null;
        items = new();
        avgRating = 0;

        // Get the currently logged-in user (driver)
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);

        // If user cannot be identified, stop loading
        if (user == null)
        {
            msg = "Unable to identify driver. Please login again.";
            isLoading = false;
            return;
        }

        // Ensure the logged-in user has a driver profile
        var driver = db.DriverProfiles.FirstOrDefault(d => d.UserId == user.Id);
        if (driver == null)
        {
            msg = "Driver profile not found.";
            isLoading = false;
            return;
        }

        // Retrieve feedback records for bookings owned by this driver
        items = (
            from f in db.Feedbacks
            join b in db.Bookings on f.BookingId equals b.BookingId

            join pp in db.PassengerProfiles on b.PassengerUserId equals pp.UserId into pps
            from pp in pps.DefaultIfEmpty()

            join u in db.Users on b.PassengerUserId equals u.Id into us
            from u in us.DefaultIfEmpty()

            where b.DriverUserId == user.Id

            // Sort by newest feedback first
            orderby f.CreatedAt descending, f.FeedbackId descending
            select new FeedbackRow
            {
                FeedbackId = f.FeedbackId,
                BookingId = b.BookingId,
                Pickup = b.PickupLocation,
                Dropoff = b.DropoffLocation,
                PickupTime = b.PickupDateTime,

                // Prefer PassengerProfiles name; fallback to Identity email
                PassengerName =
                    (pp != null && !string.IsNullOrWhiteSpace(pp.FullName)) ? pp.FullName :
                    (u != null ? u.Email : null),

                Rating = f.Rating,
                Comment = f.Comment,
                CreatedAt = f.CreatedAt
            }
        ).ToList();

        // Calculate average rating if feedback exists
        if (items.Count > 0)
        {
            avgRating = items.Average(x => x.Rating);
        }

        isLoading = false;
    }

    private void ViewJob(int bookingId)
    {
        nav.NavigateTo($"/driver/feedback/{bookingId}");
    }

    //converts a numeric rating into star icons
    private string GetStars(int rating)
    {
        //If the rating is 0 or less show no stars, cap 5 stars
        if (rating < 1) return "";
        if (rating > 5) rating = 5;
        return new string('⭐', rating);
    }

    //stores all the information needed to display a single feedback entry on the page.
    private class FeedbackRow
    {
        public int FeedbackId { get; set; }
        public int BookingId { get; set; }
        public string Pickup { get; set; } = string.Empty;
        public string Dropoff { get; set; } = string.Empty;
        public DateTime PickupTime { get; set; }
        public string? PassengerName { get; set; }
        public int Rating { get; set; }
        public string? Comment { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}
