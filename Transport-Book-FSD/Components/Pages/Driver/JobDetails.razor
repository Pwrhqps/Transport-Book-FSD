@page "/driver/job/{BookingId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Driver")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav
@inject IJSRuntime JS

<h3>Job Details</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading...</p>
}
else if (job == null)
{
    <p>Record not found.</p>
    <button class="btn btn-outline-dark" @onclick="Back">Back</button>
}
else
{
    <div class="card">
        <div class="card-header fw-bold">
            Booking #@job.BookingId
        </div>

        <div class="card-body">

            <div class="mb-3">
                <div class="fw-bold mb-1">Customer Details</div>
                <div><b>Name:</b> @customerName</div>
                <div><b>Contact:</b> @customerPhone</div>
            </div>

            <hr />

            <div class="mb-2"><b>Pickup:</b> @job.PickupLocation</div>
            <div class="mb-2"><b>Dropoff:</b> @job.DropoffLocation</div>
            <div class="mb-2"><b>Pickup Time:</b> @job.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="mb-2"><b>Status:</b> @job.Status</div>
            <div class="mb-2"><b>Fare:</b> @job.Fare.ToString("0.00")</div>
            <div class="mb-2"><b>Accepted At:</b> @(job.AcceptedAt.HasValue? job.AcceptedAt.Value.ToString("dd/MM/yyyy HH:mm") : "-")</div>

            <hr />

            <div class="mb-3">
                <div class="fw-bold mb-1">Payment</div>

                @if (job.Payment == null)
                {
                    <div>Not created yet.</div>
                    <div class="form-text">Passenger has not selected a payment method.</div>
                }
                else
                {
                    <div><b>Method:</b> @job.Payment.Method</div>
                    <div><b>Status:</b> @job.Payment.Status</div>
                    <div><b>Reference:</b> @job.Payment.ReferenceNo</div>
                }

                @if (IsPendingCash(job))
                {
                    @* Cash is "Pending" until driver confirms they received the cash *@
                    <div class="alert alert-warning mt-3 mb-0">
                        <b>Cash payment pending confirmation.</b><br />
                        Please confirm only after you have received the cash from the passenger.
                        <div class="mt-2">
                            <button class="btn btn-dark btn-sm" @onclick="ConfirmCashHere">
                                Confirm Cash Received
                            </button>
                        </div>
                    </div>
                }
            </div>

            @if (job.Status == "Accepted")
            {
                @* Finish Job is blocked if pickup time not reached OR cash not confirmed *@
                <button class="btn btn-success me-2" @onclick="ConfirmFinishJob" disabled="@(!CanFinishJob)">
                    Finish Job
                </button>

                @if (job.PickupDateTime > DateTime.Now)
                {
                    <div class="alert alert-warning mt-2 mb-0">
                        You cannot finish this job before the pickup time:
                        <b>@job.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</b>
                    </div>
                }
                else if (IsPendingCash(job))
                {
                    <div class="alert alert-warning mt-2 mb-0">
                        You must confirm <b>cash received</b> before finishing this job.
                    </div>
                }
            }

            @if (feedback != null)
            {
                <button class="btn btn-outline-primary me-2" @onclick="ViewFeedback">
                    View Feedback
                </button>
            }

            <button class="btn btn-outline-dark" @onclick="Back">Back</button>
        </div>
    </div>
}

@code {
    [Parameter] public int BookingId { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private void Back()
    {
        // returnUrl -> allows page to return to where driver came from
        nav.NavigateTo(string.IsNullOrWhiteSpace(ReturnUrl)
            ? "/driver/myjobs"
            : ReturnUrl);
    }

    private bool isLoading = true;
    private string? msg;

    private Booking? job;
    private Feedback? feedback;

    private string customerName = "-";
    private string customerPhone = "-";

    private async Task<ApplicationUser?> GetCurrentUser()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        return await userManager.GetUserAsync(authState.User);
    }

    private bool IsPendingCash(Booking b)
    {
        // Pending cash = passenger chose cash, payment still pending, booking not marked paid yet
        return b.Payment != null
            && b.Payment.Method == "Cash"
            && b.Payment.Status == "Pending"
            && !b.IsPaid;
    }

    private bool CanFinishJob
    {
        get
        {
            // Finish rules:
            // 1) job must be Accepted
            // 2) pickup time must have started/passed
            // 3) cash (if any) must be confirmed first
            return job != null
                && job.Status == "Accepted"
                && job.PickupDateTime <= DateTime.Now
                && !IsPendingCash(job);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        isLoading = true;
        msg = null;

        customerName = "-";
        customerPhone = "-";
        job = null;
        feedback = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            isLoading = false;
            return;
        }

        // Include(Payment) -> needto show payment info and check pending cash
        // DriverUserId check -> driver can only view their own job
        job = db.Bookings
            .Include(b => b.Payment)
            .FirstOrDefault(b =>
                b.BookingId == BookingId &&
                b.DriverUserId == user.Id
            );

        if (job == null)
        {
            isLoading = false;
            return;
        }

        // Get customer name/contact from PassengerProfiles (fallback to user email if missing)
        if (!string.IsNullOrWhiteSpace(job.PassengerUserId))
        {
            var pp = db.PassengerProfiles.FirstOrDefault(p => p.UserId == job.PassengerUserId);
            if (pp != null)
            {
                customerName = string.IsNullOrWhiteSpace(pp.FullName) ? "-" : pp.FullName;
                customerPhone = string.IsNullOrWhiteSpace(pp.ContactNumber) ? "-" : pp.ContactNumber;
            }
        }

        if (customerName == "-" && !string.IsNullOrWhiteSpace(job.PassengerUserId))
        {
            var passengerUser = await userManager.FindByIdAsync(job.PassengerUserId);
            if (passengerUser != null)
            {
                customerName = string.IsNullOrWhiteSpace(passengerUser.Email) ? "-" : passengerUser.Email;
            }
        }

        // feedback is optional (only exists if passenger submitted)
        feedback = db.Feedbacks.FirstOrDefault(f => f.BookingId == job.BookingId);

        isLoading = false;
    }

    private async Task ConfirmFinishJob()
    {
        if (job == null) return;

        // Extra guard even if button is disabled
        if (!CanFinishJob)
        {
            if (job.PickupDateTime > DateTime.Now)
            {
                msg = "You cannot finish this job before the scheduled pickup time.";
            }
            else if (IsPendingCash(job))
            {
                msg = "Please confirm cash received before finishing this job.";
            }
            return;
        }

        var ok = await JS.InvokeAsync<bool>(
            "confirm",
            "Are you sure you want to finish this job?"
        );

        if (!ok) return;

        await FinishJob();
    }

    private async Task FinishJob()
    {
        msg = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            return;
        }

        // Reload from DB -> ensures latest status/payment before updating
        var b = db.Bookings
            .Include(x => x.Payment)
            .FirstOrDefault(x => x.BookingId == BookingId && x.DriverUserId == user.Id);

        if (b == null)
        {
            msg = "Job not found.";
            return;
        }

        if (b.Status != "Accepted")
        {
            msg = "Only accepted jobs can be completed.";
            return;
        }

        if (b.PickupDateTime > DateTime.Now)
        {
            msg = "You cannot finish this job before the scheduled pickup time.";
            return;
        }

        if (IsPendingCash(b))
        {
            msg = "Please confirm cash received before finishing this job.";
            return;
        }

        b.Status = "Completed";
        await db.SaveChangesAsync();

        msg = "Job marked as completed.";
        await Load();
    }

    private async Task ConfirmCashHere()
    {
        if (job == null) return;

        if (!IsPendingCash(job))
        {
            msg = "No pending cash payment found for this booking.";
            return;
        }

        var ok = await JS.InvokeAsync<bool>(
            "confirm",
            "Confirm that you have received the cash from the passenger?"
        );

        if (!ok) return;

        await ConfirmCash();
    }

    private async Task ConfirmCash()
    {
        msg = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            return;
        }

        // Reload booking with payment
        var b = db.Bookings
            .Include(x => x.Payment)
            .FirstOrDefault(x => x.BookingId == BookingId && x.DriverUserId == user.Id);

        if (b == null)
        {
            msg = "Booking not found.";
            return;
        }

        // Must still be pending cash, otherwise block double confirm
        if (b.Payment == null || b.Payment.Method != "Cash" || b.Payment.Status != "Pending" || b.IsPaid)
        {
            msg = "This cash payment is no longer pending.";
            await Load();
            return;
        }

        var now = DateTime.Now;

        // Cash confirm -> mark payment succeeded and booking paid
        b.Payment.Status = "Succeeded";
        b.Payment.CompletedAt = now;

        b.IsPaid = true;
        b.PaidAt = now;

        await db.SaveChangesAsync();

        msg = $"Cash confirmed. Ref: {b.Payment.ReferenceNo}";
        await Load();
    }

    private void ViewFeedback()
    {
        nav.NavigateTo($"/driver/feedback/{BookingId}");
    }
}
