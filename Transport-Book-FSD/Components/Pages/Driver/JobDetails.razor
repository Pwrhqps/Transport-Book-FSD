@page "/driver/job/{BookingId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Driver")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav
@inject IJSRuntime JS

<h3>Job Details</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading...</p>
}
else if (job == null)
{
    <p>Record not found.</p>
    <button class="btn btn-outline-dark" @onclick="Back">Back</button>
}
else
{
    <div class="card">
        <div class="card-header fw-bold">
            Booking #@job.BookingId
        </div>

        <div class="card-body">

            <div class="mb-3">
                <div class="fw-bold mb-1">Customer Details</div>
                <div><b>Name:</b> @customerName</div>
                <div><b>Contact:</b> @customerPhone</div>
            </div>

            <hr />

            <div class="mb-2"><b>Pickup:</b> @job.PickupLocation</div>
            <div class="mb-2"><b>Dropoff:</b> @job.DropoffLocation</div>
            <div class="mb-2"><b>Pickup Time:</b> @job.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="mb-2"><b>Status:</b> @job.Status</div>
            <div class="mb-2"><b>Fare:</b> @job.Fare.ToString("0.00")</div>
            <div class="mb-2"><b>Accepted At:</b> @(job.AcceptedAt.HasValue? job.AcceptedAt.Value.ToString("dd/MM/yyyy HH:mm") : "-")</div>

            <hr />

            <!-- Payment status display + inline cash confirm -->
            <div class="mb-3">
                <div class="fw-bold mb-1">Payment</div>

                @if (job.Payment == null)
                {
                    <div>Not created yet.</div>
                    <div class="form-text">Passenger has not selected a payment method.</div>
                }
                else
                {
                    <div><b>Method:</b> @job.Payment.Method</div>
                    <div><b>Status:</b> @job.Payment.Status</div>
                    <div><b>Reference:</b> @job.Payment.ReferenceNo</div>
                }

                @if (IsPendingCash(job))
                {
                    <div class="alert alert-warning mt-3 mb-0">
                        <b>Cash payment pending confirmation.</b><br />
                        Please confirm only after you have received the cash from the passenger.
                        <div class="mt-2">
                            <button class="btn btn-dark btn-sm" @onclick="ConfirmCashHere">
                                Confirm Cash Received
                            </button>
                        </div>
                    </div>
                }
            </div>

            @if (job.Status == "Accepted")
            {
                <button class="btn btn-success me-2" @onclick="ConfirmFinishJob">
                    Finish Job
                </button>
            }

            @if (feedback != null)
            {
                <button class="btn btn-outline-primary me-2" @onclick="ViewFeedback">
                    View Feedback
                </button>
            }

            <button class="btn btn-outline-dark" @onclick="Back">Back</button>
        </div>
    </div>
}

@code {
    [Parameter] public int BookingId { get; set; }

    private bool isLoading = true;
    private string? msg;

    private Booking? job;
    private Feedback? feedback;

    private string customerName = "-";
    private string customerPhone = "-";

    private async Task<ApplicationUser?> GetCurrentUser()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        return await userManager.GetUserAsync(authState.User);
    }

    private bool IsPendingCash(Booking b)
    {
        return b.Payment != null
            && b.Payment.Method == "Cash"
            && b.Payment.Status == "Pending"
            && !b.IsPaid;
    }

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        isLoading = true;
        msg = null;

        customerName = "-";
        customerPhone = "-";
        job = null;
        feedback = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            isLoading = false;
            return;
        }

        // IMPORTANT: include Payment so we can show payment status + pending cash button
        job = db.Bookings
            .Include(b => b.Payment)
            .FirstOrDefault(b =>
                b.BookingId == BookingId &&
                b.DriverUserId == user.Id
            );

        if (job == null)
        {
            isLoading = false;
            return;
        }

        // Customer details: PassengerProfiles via PassengerUserId
        if (!string.IsNullOrWhiteSpace(job.PassengerUserId))
        {
            var pp = db.PassengerProfiles.FirstOrDefault(p => p.UserId == job.PassengerUserId);
            if (pp != null)
            {
                customerName = string.IsNullOrWhiteSpace(pp.FullName) ? "-" : pp.FullName;
                customerPhone = string.IsNullOrWhiteSpace(pp.ContactNumber) ? "-" : pp.ContactNumber;
            }
        }

        // Optional: fallback to AspNetUsers email if profile missing
        if (customerName == "-" && !string.IsNullOrWhiteSpace(job.PassengerUserId))
        {
            var passengerUser = await userManager.FindByIdAsync(job.PassengerUserId);
            if (passengerUser != null)
            {
                customerName = string.IsNullOrWhiteSpace(passengerUser.Email) ? "-" : passengerUser.Email;
            }
        }

        feedback = db.Feedbacks.FirstOrDefault(f => f.BookingId == job.BookingId);

        isLoading = false;
    }

    // ✅ CONFIRMATION POPUP (Finish Job)
    private async Task ConfirmFinishJob()
    {
        if (job == null) return;

        var ok = await JS.InvokeAsync<bool>(
            "confirm",
            "Are you sure you want to finish this job?"
        );

        if (!ok) return;

        await FinishJob();
    }

    private async Task FinishJob()
    {
        msg = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            return;
        }

        // Reload from DB with ownership check
        var b = db.Bookings.FirstOrDefault(x => x.BookingId == BookingId && x.DriverUserId == user.Id);
        if (b == null)
        {
            msg = "Job not found.";
            return;
        }

        if (b.Status != "Accepted")
        {
            msg = "Only accepted jobs can be completed.";
            return;
        }

        b.Status = "Completed";
        await db.SaveChangesAsync();

        msg = "Job marked as completed.";
        await Load();
    }

    // ✅ NEW: Confirm cash received directly inside Job Details
    private async Task ConfirmCashHere()
    {
        if (job == null) return;

        // Must be pending cash
        if (!IsPendingCash(job))
        {
            msg = "No pending cash payment found for this booking.";
            return;
        }

        var ok = await JS.InvokeAsync<bool>(
            "confirm",
            "Confirm that you have received the cash from the passenger?"
        );

        if (!ok) return;

        await ConfirmCash();
    }

    private async Task ConfirmCash()
    {
        msg = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            return;
        }

        // Reload booking WITH payment
        var b = db.Bookings
            .Include(x => x.Payment)
            .FirstOrDefault(x => x.BookingId == BookingId && x.DriverUserId == user.Id);

        if (b == null)
        {
            msg = "Booking not found.";
            return;
        }

        if (b.Payment == null || b.Payment.Method != "Cash" || b.Payment.Status != "Pending" || b.IsPaid)
        {
            msg = "This cash payment is no longer pending.";
            await Load();
            return;
        }

        var now = DateTime.Now;

        // Mark payment as succeeded
        b.Payment.Status = "Succeeded";
        b.Payment.CompletedAt = now;

        // If you added these fields in Payment.cs (recommended)
        // b.Payment.ConfirmedAt = now;
        // b.Payment.ConfirmedByUserId = user.Id;
        // b.Payment.ConfirmedByRole = "Driver";

        // Mark this booking paid
        b.IsPaid = true;
        b.PaidAt = now;

        await db.SaveChangesAsync();

        msg = $"Cash confirmed. Ref: {b.Payment.ReferenceNo}";
        await Load();
    }

    private void ViewFeedback()
    {
        nav.NavigateTo($"/driver/feedback/{BookingId}");
    }

    private void Back()
    {
        nav.NavigateTo("/driver/myjobs");
    }
}
