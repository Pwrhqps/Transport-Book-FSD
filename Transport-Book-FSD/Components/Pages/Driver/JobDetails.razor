@page "/driver/job/{BookingId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Transport_Book_FSD.Data
@using Transport_Book_FSD.Models
@attribute [Authorize(Roles = "Driver")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav
@inject IJSRuntime JS

<h3>Job Details</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading...</p>
}
else if (job == null)
{
    <p>Record not found.</p>
    <button class="btn btn-outline-dark" @onclick="Back">Back</button>
}
else
{
    <div class="card">
        <div class="card-header fw-bold">
            Booking #@job.BookingId
        </div>

        <div class="card-body">

            <div class="mb-3">
                <div class="fw-bold mb-1">Customer Details</div>
                <div><b>Name:</b> @customerName</div>
                <div><b>Contact:</b> @customerPhone</div>
            </div>

            <hr />

            <div class="mb-2"><b>Pickup:</b> @job.PickupLocation</div>
            <div class="mb-2"><b>Dropoff:</b> @job.DropoffLocation</div>
            <div class="mb-2"><b>Pickup Time:</b> @job.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="mb-2"><b>Status:</b> @job.Status</div>
            <div class="mb-2"><b>Fare:</b> @job.Fare.ToString("0.00")</div>
            <div class="mb-2"><b>Accepted At:</b> @(job.AcceptedAt.HasValue? job.AcceptedAt.Value.ToString("dd/MM/yyyy HH:mm") : "-")</div>

            <hr />

            @if (job.Status == "Accepted")
            {
                <button class="btn btn-success me-2" @onclick="ConfirmFinishJob">
                    Finish Job
                </button>
            }

            @if (feedback != null)
            {
                <button class="btn btn-outline-primary me-2" @onclick="ViewFeedback">
                    View Feedback
                </button>
            }

            <button class="btn btn-outline-dark" @onclick="Back">Back</button>
        </div>
    </div>
}

@code {
    [Parameter] public int BookingId { get; set; }

    private bool isLoading = true;
    private string? msg;

    private Booking? job;
    private Feedback? feedback;

    private string customerName = "-";
    private string customerPhone = "-";

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        isLoading = true;
        msg = null;

        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);

        if (user == null)
        {
            msg = "Please login again.";
            isLoading = false;
            return;
        }

        var driver = db.DriverProfiles.FirstOrDefault(d => d.UserId == user.Id);
        if (driver == null)
        {
            msg = "Driver profile not found.";
            isLoading = false;
            return;
        }

        job = db.Bookings.FirstOrDefault(b =>
            b.BookingId == BookingId &&
            b.DriverId == driver.DriverProfileId
        );

        if (job != null)
        {
            var passenger = db.Passengers.FirstOrDefault(p => p.PassengerId == job.PassengerId);
            if (passenger != null)
            {
                customerName = passenger.Name;
                customerPhone = passenger.Phone;
            }

            feedback = db.Feedbacks.FirstOrDefault(f => f.BookingId == job.BookingId);
        }

        isLoading = false;
    }

    // ✅ CONFIRMATION POPUP
    private async Task ConfirmFinishJob()
    {
        if (job == null) return;

        var ok = await JS.InvokeAsync<bool>(
            "confirm",
            "Are you sure you want to finish this job?"
        );

        if (!ok) return;

        await FinishJob();
    }

    private async Task FinishJob()
    {
        msg = null;

        if (job == null)
        {
            msg = "Job not found.";
            return;
        }

        if (job.Status != "Accepted")
        {
            msg = "Only accepted jobs can be completed.";
            return;
        }

        job.Status = "Completed";
        await db.SaveChangesAsync();

        msg = "Job marked as completed.";
        await Load();
    }

    private void ViewFeedback()
    {
        nav.NavigateTo($"/driver/feedback/{BookingId}");
    }

    private void Back()
    {
        nav.NavigateTo("/driver/myjobs");
    }
}
