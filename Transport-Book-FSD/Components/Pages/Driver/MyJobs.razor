@page "/driver/myjobs"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Driver")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>My Jobs</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading your jobs...</p>
}
else
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label fw-bold">Filter by pickup date</label>
                    <select class="form-select" @bind="dateFilter" @bind:event="onchange">
                        <option value="All">All</option>
                        <option value="Today">Today</option>
                        <option value="Next7">Next 7 days</option>
                        <option value="Next30">Next 30 days</option>
                    </select>
                </div>
                <div class="col-12 col-md-8 text-md-end">
                    <small class="text-muted">
                        Showing @jobs.Count job(s)
                    </small>
                </div>
            </div>
        </div>
    </div>

    if (jobs.Count == 0)
    {
        <p>You have no accepted jobs for the selected filter.</p>

        <button class="btn btn-dark me-2" @onclick="GoAvailable">Go to Available Jobs</button>
        <button class="btn btn-outline-dark" @onclick="GoCompletedJobs">Completed Jobs</button>
    }
    else
    {
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Pickup</th>
                    <th>Dropoff</th>
                    <th>Pickup Time</th>
                    <th>Status</th>
                    <th>Fare</th>
                    <th>Accepted At</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int row = 1;
                }
                @foreach (var j in jobs)
                {
                    <tr>
                        <td>@row</td>
                        <td>@j.PickupLocation</td>
                        <td>@j.DropoffLocation</td>
                        <td>@j.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@j.Status</td>
                        <td>@j.Fare.ToString("0.00")</td>
                        <td>@(j.AcceptedAt.HasValue? j.AcceptedAt.Value.ToString("dd/MM/yyyy HH:mm") : "-")</td>
                        <td>
                            <button class="btn btn-sm btn-outline-dark" @onclick="() => ViewJob(j.BookingId)">
                                View
                            </button>
                        </td>
                    </tr>
                    row++;
                }
            </tbody>
        </table>

        <button class="btn btn-outline-dark me-2" @onclick="GoAvailable">View Available Jobs</button>
        <button class="btn btn-outline-dark" @onclick="GoCompletedJobs">Completed Jobs</button>
    }
}

@code {
    private bool isLoading = true;

    private List<Booking> allJobs = new();
    private List<Booking> jobs = new();

    private string? msg;

    // All | Today | Next7 | Next30
    private string dateFilter = "All";

    protected override async Task OnInitializedAsync()
    {
        await LoadJobs();
        ApplyFilter();
    }

    private void GoAvailable()
    {
        nav.NavigateTo("/driver/jobs");
    }

    private void GoCompletedJobs()
    {
        nav.NavigateTo("/driver/completedjobs");
    }

    private async Task LoadJobs()
    {
        isLoading = true;
        msg = null;

        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);

        if (user == null)
        {
            msg = "Unable to identify driver. Please login again.";
            isLoading = false;
            return;
        }

        // Optional: keep profile check (ensures driver has a profile)
        var driver = db.DriverProfiles.FirstOrDefault(d => d.UserId == user.Id);
        if (driver == null)
        {
            msg = "Driver profile not found.";
            isLoading = false;
            return;
        }

        // Only show ACTIVE jobs here (Accepted)
        allJobs = db.Bookings
            .Where(b => b.DriverUserId == user.Id && b.Status == "Accepted")
            .OrderBy(b => b.PickupDateTime)
            .ThenBy(b => b.BookingId)
            .ToList();

        isLoading = false;
    }

    private void ApplyFilter()
    {
        // Start by showing all accepted jobs by default.
        jobs = allJobs.ToList();

        var now = DateTime.Now;

        if (dateFilter == "Today")
        {
            // "Today" means from 00:00 of the current day until just before tomorrow
            var start = now.Date;
            var end = start.AddDays(1);
            jobs = allJobs
                .Where(b => b.PickupDateTime >= start && b.PickupDateTime < end)
                .ToList();
        }
        else if (dateFilter == "Next7")
        {
            // Shows jobs scheduled from now up to the next 7 days
            var end = now.AddDays(7);
            jobs = allJobs
                .Where(b => b.PickupDateTime >= now && b.PickupDateTime <= end)
                .ToList();
        }
        else if (dateFilter == "Next30")
        {
            // Shows upcoming jobs within the next 30 days for longer-term planning
            var end = now.AddDays(30);
            jobs = allJobs
                .Where(b => b.PickupDateTime >= now && b.PickupDateTime <= end)
                .ToList();
        }
    }

    // called automatically when dropdown changes (because @bind:event="onchange")
    private string DateFilter
    {
        get => dateFilter;
        set
        {
            dateFilter = value;
            ApplyFilter();
        }
    }

    private void ViewJob(int bookingId)
    {
        nav.NavigateTo($"/driver/job/{bookingId}");
    }
}
