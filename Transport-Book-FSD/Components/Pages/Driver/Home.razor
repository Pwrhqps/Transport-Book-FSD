@page "/driver/home"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using TransportBookFSD.Data
@using TransportBookFSD.Models

@attribute [Authorize(Roles = "Driver")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav
@inject IJSRuntime JS

<h3>Driver Home</h3>

@if (!string.IsNullOrEmpty(msg))
{
    //Shows messages like “Profile not found”, “Cash out successful”, “Please add payout card…”
    <div class="alert alert-info">@msg</div> 
}

@if (isLoading)
{
    <p>Loading profile...</p>
}
else if (profile == null)
{
    @* Driver has no profile yet (must create before using driver features) *@
    <p>No driver profile found.</p>
    <button class="btn btn-dark" @onclick="GoToProfile">Create Profile</button>
}
else
{
    var status = string.IsNullOrWhiteSpace(profile.VerificationStatus) ? "Pending" : profile.VerificationStatus;

    @if (status != "Approved")
    {
        @* Pending/Rejected warning shown clearly on home page *@
        <div class="alert alert-warning">
            @if (status == "Rejected")
            {
                <div><b>Verification Status:</b> Rejected</div>
                <div><b>Remarks:</b> @(string.IsNullOrWhiteSpace(profile.VerificationRemarks) ? "No remarks provided." : profile.VerificationRemarks)</div>
                <div class="mt-2">Update your profile details and press Save to resubmit for verification.</div>
            }
            else
            {
                <div><b>Verification Status:</b> Pending</div>
                <div>Please wait for staff approval before accepting jobs.</div>
            }
        </div>
    }

    <div class="card mb-3">
        <div class="card-header fw-bold">My Profile</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-2"><b>Full Name:</b> @profile.FullName</div>
                    <div class="mb-2"><b>Contact:</b> @profile.ContactNumber</div>
                    <div class="mb-2"><b>Gender:</b> @profile.Gender</div>
                    <div class="mb-2">
                        <b>Date of Birth:</b>
                        @(profile.DateOfBirth.HasValue? profile.DateOfBirth.Value.ToString("dd/MM/yyyy") : "")
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-2"><b>Vehicle Type:</b> @profile.VehicleType</div>
                    <div class="mb-2"><b>Vehicle Model:</b> @profile.VehicleModel</div>
                    <div class="mb-2"><b>Vehicle Plate:</b> @profile.VehiclePlate</div>

                    <hr />

                    <div class="mb-2"><b>Total Completed Trips:</b> @totalCompletedTrips</div>

                    @* Earnings breakdown is displayed separately for Cash vs Card *@
                    <div class="mb-2">
                        <b>Total Earnings (Cash):</b> @availableCashEarnings.ToString("0.00")
                        <div class="form-text">Cash is collected physically from passengers.</div>
                    </div>

                    <div class="mb-2">
                        <b>Total Earnings (Card):</b> @availableCardBalance.ToString("0.00")
                        <div class="form-text">Card earnings can be cashed out to your payout card.</div>
                    </div>

                    @* Earnings only count when job is completed + payment succeeded *@
                    <div class="form-text">
                        Earnings are counted only for <b>Completed</b> jobs that are <b>Paid</b>.
                    </div>
                    <div class="form-text mt-1">
                        Cash out is used to acknowledge and record earnings.
                        Please ensure you have already collected the cash before cashing out.
                    </div>
                </div>
            </div>

            <hr />

            <div class="row">
                <div class="col-md-6">
                    <div class="fw-bold mb-2">Payout Card (for Card Earnings)</div>

                    @* Payout card is required before card earnings can be cashed out *@
                    @if (!HasPayoutCard())
                    {
                        <div class="mb-2">
                            <label class="form-label">Card Name (e.g. DBS Visa)</label>
                            @* @bind keeps UI input synced with variables *@
                            <input class="form-control" @bind="payoutCardName" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Last 4 digits</label>
                            @* maxlength = 4 to limit user input *@
                            <input class="form-control" maxlength="4" @bind="payoutCardLast4" />
                        </div>

                        <button class="btn btn-outline-dark" @onclick="SavePayoutCard">
                            Save Payout Card
                        </button>
                    }
                    else
                    {
                        @* Display masked saved payout card *@
                        <div class="mb-2">
                            <b>Saved:</b> @profile.PayoutCardName ****@profile.PayoutCardLast4
                        </div>

                        <button class="btn btn-outline-dark btn-sm" @onclick="EditPayoutCard">
                            Change Payout Card
                        </button>
                    }
                </div>

                <div class="col-md-6">
                    <div class="fw-bold mb-2">Cash Out</div>

                    @* Cash Out button availability depends on earnings + payout card rules *@
                    @if (availableCashEarnings <= 0 && availableCardBalance <= 0)
                    {
                        <div class="alert alert-info mb-2">
                            No earnings available to cash out yet.
                        </div>
                        <button class="btn btn-dark" disabled>Cash Out</button>
                    }
                    else if (availableCardBalance > 0 && !HasPayoutCard())
                    {
                        <div class="alert alert-warning mb-2">
                            Add a payout card first to cash out <b>card</b> earnings.
                            (You can still cash out cash earnings after adding a payout card.)
                        </div>
                        <button class="btn btn-dark" disabled>Cash Out</button>
                    }
                    else
                    {
                        @* Show what will be cashed out before user confirms *@
                        <div class="mb-2">
                            This will cash out:
                            <ul class="mb-2">
                                <li><b>Cash:</b> @availableCashEarnings.ToString("0.00") (acknowledgement)</li>
                                <li><b>Card:</b> @availableCardBalance.ToString("0.00") @(HasPayoutCard() ? $"to {profile.PayoutCardName} ****{profile.PayoutCardLast4}" : "")</li>
                            </ul>
                        </div>

                        <button class="btn btn-dark" @onclick="ConfirmCashOut">
                            Cash Out Now
                        </button>
                    }
                </div>
            </div>

            <div class="mt-3">
                <button class="btn btn-dark" @onclick="GoToProfile">Go to Profile</button>
            </div>
        </div>
    </div>
}

@code {
    // profile -> current driver's profile data
    private DriverProfile? profile;

    private bool isLoading = true;

    // msg -> user-visible message at top of page
    private string? msg;

    private int totalCompletedTrips = 0;

    private decimal totalCashEarnings = 0m;
    private decimal totalCardEarnings = 0m;

    private decimal totalCashCashedOut = 0m;
    private decimal totalCardCashedOut = 0m;

    private decimal availableCashEarnings = 0m;
    private decimal availableCardBalance = 0m;

    private string payoutCardName = "";
    private string payoutCardLast4 = "";

    // When editing payout card, do not overwrite input fields during reload
    private bool isEditingPayoutCard = false;

    protected override async Task OnInitializedAsync()
    {
        // Load profile + earnings 
        await Load();
    }

    private async Task Load()
    {
        isLoading = true;
        msg = null;

        // Reset all values before reloading from database
        profile = null;

        totalCompletedTrips = 0;
        totalCashEarnings = 0m;
        totalCardEarnings = 0m;

        totalCashCashedOut = 0m;
        totalCardCashedOut = 0m;

        availableCashEarnings = 0m;
        availableCardBalance = 0m;

        // Get current logged-in user via AuthenticationStateProvider + UserManager
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);

        if (user != null)
        {
            // Load driver's profile record
            profile = db.DriverProfiles.FirstOrDefault(p => p.UserId == user.Id);

            if (profile != null)
            {
                // Count completed trips for driver
                totalCompletedTrips = db.Bookings
                    .Count(b => b.DriverUserId == user.Id && b.Status == "Completed");

                // paidCompleted -> base query for earnings calculation
                // Include(Payment) -> access payment method and status
                var paidCompleted = db.Bookings
                    .Include(b => b.Payment)
                    .Where(b => b.DriverUserId == user.Id
                        && b.Status == "Completed"
                        && b.IsPaid
                        && b.Payment != null
                        && b.Payment.Status == Payment.PaymentStatuses.Succeeded);

                // Sum cash earnings: payment method Cash
                // (decimal?) + ?? 0m -> Sum() can be null when no records, so default to 0
                totalCashEarnings = paidCompleted
                    .Where(b => b.Payment!.Method == "Cash")
                    .Select(b => (decimal?)b.Fare)
                    .Sum() ?? 0m;

                // Balance -> passenger uses stored balance
                totalCardEarnings = paidCompleted
                    .Where(b => b.Payment!.Method == "Card" || b.Payment!.Method == "Balance")
                    .Select(b => (decimal?)b.Fare)
                    .Sum() ?? 0m;

                // Amount ensures only cash out records are counted
                // Find how much has already been cashed out (Cash)
                totalCashCashedOut = db.WalletTransactions
                    .Where(t => t.UserId == user.Id
                        && t.Type == "CashOut"
                        && t.Method == "Cash"
                        && t.Amount < 0)
                    .Select(t => (decimal?)t.Amount)
                    .Sum() ?? 0m;

                // Find how much has already been cashed out (Card)
                totalCardCashedOut = db.WalletTransactions
                    .Where(t => t.UserId == user.Id
                        && t.Type == "CashOut"
                        && t.Method == "Card"
                        && t.Amount < 0)
                    .Select(t => (decimal?)t.Amount)
                    .Sum() ?? 0m;

                // Convert any negative totals into positive amounts for display
                // Negative amounts indicate cash out records
                totalCashCashedOut = Math.Abs(totalCashCashedOut);
                totalCardCashedOut = Math.Abs(totalCardCashedOut);

                // Earnings that have not been cashed out yet
                availableCashEarnings = totalCashEarnings - totalCashCashedOut;
                if (availableCashEarnings < 0) availableCashEarnings = 0;

                availableCardBalance = totalCardEarnings - totalCardCashedOut;
                if (availableCardBalance < 0) availableCardBalance = 0;

                // Populate payout card input fields only when not currently editing
                if (!isEditingPayoutCard)
                {
                    payoutCardName = profile.PayoutCardName ?? "";
                    payoutCardLast4 = profile.PayoutCardLast4 ?? "";
                }
            }
        }

        isLoading = false;
    }

    private bool HasPayoutCard()
    {
        // Payout card requires card name + exactly 4 digits
        if (profile == null) return false;
        return !string.IsNullOrWhiteSpace(profile.PayoutCardName)
            && !string.IsNullOrWhiteSpace(profile.PayoutCardLast4)
            && profile.PayoutCardLast4!.Length == 4;
    }

    private void EditPayoutCard()
    {
        // Load existing values into input fields
        isEditingPayoutCard = true;
        payoutCardName = profile?.PayoutCardName ?? "";
        payoutCardLast4 = profile?.PayoutCardLast4 ?? "";
        msg = null;
    }

    private async Task SavePayoutCard()
    {
        msg = null;

        if (profile == null)
        {
            msg = "Profile not found.";
            return;
        }

        // card name cannot be empty
        if (string.IsNullOrWhiteSpace(payoutCardName))
        {
            msg = "Please enter a card name.";
            return;
        }

        // last 4 digits must be numeric and length 4
        if (string.IsNullOrWhiteSpace(payoutCardLast4) || payoutCardLast4.Length != 4 || !payoutCardLast4.All(char.IsDigit))
        {
            msg = "Please enter last 4 digits (numbers only).";
            return;
        }

        // Save payout card into DriverProfile table
        profile.PayoutCardName = payoutCardName.Trim();
        profile.PayoutCardLast4 = payoutCardLast4.Trim();
        await db.SaveChangesAsync();

        isEditingPayoutCard = false;
        msg = "Payout card saved.";
        await Load(); // reload to refresh displayed summary
    }

    private async Task ConfirmCashOut()
    {
        if (profile == null) return;

        // No earnings available
        if (availableCashEarnings <= 0 && availableCardBalance <= 0)
        {
            msg = "No earnings available to cash out.";
            return;
        }

        // Cannot cash out card earnings without payout card
        if (availableCardBalance > 0 && !HasPayoutCard())
        {
            msg = "Please add a payout card to cash out card earnings.";
            return;
        }

        // JS confirm dialog shows a summary before creating wallet transactions
        var text =
            $"Cash out summary:\n" +
            $"- Cash: {availableCashEarnings:0.00} (acknowledgement)\n" +
            $"- Card: {availableCardBalance:0.00}\n\n" +
            $"Continue?";

        // JS confirm -> quick client-side confirmation before committing DB changes
        var ok = await JS.InvokeAsync<bool>("confirm", text);
        if (!ok) return;

        await CashOut();
    }

    private async Task CashOut()
    {
        msg = null;

        // Re-check current user at the time of action
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);

        if (user == null)
        {
            msg = "Please login again.";
            return;
        }

        // Re-check earnings at the time of cash out
        if (availableCashEarnings <= 0 && availableCardBalance <= 0)
        {
            msg = "No earnings available to cash out.";
            return;
        }

        if (availableCardBalance > 0 && !HasPayoutCard())
        {
            msg = "Please add a payout card to cash out card earnings.";
            return;
        }

        // baseRef -> used to generate a readable unique reference number
        var baseRef = DateTime.Now.ToString("yyyyMMddHHmmss");

        // Cash acknowledgement (cash should already be collected physically)
        if (availableCashEarnings > 0)
        {
            db.WalletTransactions.Add(new WalletTransaction
            {
                UserId = user.Id,
                Amount = -availableCashEarnings,
                Type = "CashOut",
                Method = "Cash",
                ReferenceNo = "CASH" + baseRef,
                BookingId = null,
                PassengerCardId = null,
                CreatedAt = DateTime.Now
            });
        }

        // Card payout (money goes to the payout card stored in DriverProfile)
        if (availableCardBalance > 0)
        {
            db.WalletTransactions.Add(new WalletTransaction
            {
                UserId = user.Id,
                Amount = -availableCardBalance,
                Type = "CashOut",
                Method = "Card",
                ReferenceNo = "CARD" + baseRef,
                BookingId = null,
                PassengerCardId = null,
                CreatedAt = DateTime.Now
            });
        }

        await db.SaveChangesAsync();

        msg = "Cash out successful.";
        await Load(); // reload totals so available earnings become 0 after cash out
    }

    private void GoToProfile()
    {
        nav.NavigateTo("/driver/profile");
    }
}
