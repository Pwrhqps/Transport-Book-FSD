@page "/staff/userdetails/{UserId}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Transport_Book_FSD.Data
@using Transport_Book_FSD.Models
@attribute [Authorize(Policy = "Staff2FA")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject NavigationManager nav

<h3>User Details</h3>

@if (isLoading)
{
    <p>Loading user...</p>
}
else if (user == null)
{
    <p>User not found.</p>
    <button class="btn btn-outline-dark" @onclick="Back">Back</button>
}
else
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-12 col-md-6">
                    <div class="fw-bold">Email</div>
                    <div>@(user.Email ?? "")</div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="fw-bold">Role</div>
                    <div>@role</div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="fw-bold">Name</div>
                    <div>@displayName</div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="fw-bold">Phone</div>
                    <div>@phone</div>
                </div>
            </div>
        </div>
    </div>

    @if (role == "Passenger")
    {
        <h5>Passenger Profile</h5>
        @if (passengerProfile == null)
        {
            <p>No passenger profile record found.</p>
        }
        else
        {
            <table class="table table-bordered">
                <tbody>
                    <tr><th style="width:220px;">Gender</th><td>@passengerProfile.Gender</td></tr>
                    <tr><th>Date of Birth</th><td>@(passengerProfile.DateOfBirth?.ToString("dd/MM/yyyy") ?? "")</td></tr>
                    <tr><th>Address</th><td>@passengerProfile.ResidentialAddress</td></tr>
                    <tr><th>Emergency Contact</th><td>@passengerProfile.EmergencyContact</td></tr>
                    <tr><th>Total Completed Trips</th><td>@passengerProfile.TotalCompletedTrips</td></tr>
                    <tr><th>Penalty Balance</th><td>@passengerProfile.CancellationPenaltyBalance.ToString("0.00")</td></tr>
                </tbody>
            </table>
        }
    }
    else if (role == "Driver")
    {
        <h5>Driver Profile</h5>
        @if (driverProfile == null)
        {
            <p>No driver profile record found.</p>
        }
        else
        {
            <div class="mb-3" style="max-width:320px;">
                <label class="form-label fw-bold">Interview Date</label>
                <InputDate TValue="DateTime?" class="form-control" @bind-Value="interviewDate" />
                <button class="btn btn-sm btn-outline-dark mt-2" @onclick="SaveInterviewDate">Save</button>
            </div>

            <table class="table table-bordered">
                <tbody>
                    <tr><th style="width:220px;">Gender</th><td>@driverProfile.Gender</td></tr>
                    <tr><th>Date of Birth</th><td>@(driverProfile.DateOfBirth?.ToString("dd/MM/yyyy") ?? "")</td></tr>
                    <tr><th>Interview Date</th><td>@(driverProfile.InterviewDate?.ToString("dd/MM/yyyy") ?? "")</td></tr>
                    <tr><th>Vehicle Type</th><td>@driverProfile.VehicleType</td></tr>
                    <tr><th>Vehicle Model</th><td>@driverProfile.VehicleModel</td></tr>
                    <tr><th>Vehicle Plate</th><td>@driverProfile.VehiclePlate</td></tr>
                    <tr><th>License Number</th><td>@driverProfile.LicenseNumber</td></tr>
                    <tr><th>Total Completed Trips</th><td>@driverProfile.TotalCompletedTrips</td></tr>
                    <tr><th>Total Earnings</th><td>@driverProfile.TotalEarnings.ToString("0.00")</td></tr>
                    <tr><th>Rating</th><td>@driverProfile.Rating.ToString("0.0")</td></tr>
                </tbody>
            </table>
        }
    }

    <button class="btn btn-outline-dark" @onclick="Back">Back</button>
}

@code {
    [Parameter] public string UserId { get; set; } = "";

    private bool isLoading = true;

    private ApplicationUser? user;
    private string role = "";
    private string displayName = "";
    private string phone = "";

    private PassengerProfile? passengerProfile;
    private DriverProfile? driverProfile;

    private DateTime? interviewDate;

    protected override async Task OnParametersSetAsync()
    {
        await Load();
    }

    private async Task SaveInterviewDate()
    {
        if (driverProfile == null) return;

        var d = await db.DriverProfiles.FirstOrDefaultAsync(x => x.DriverProfileId == driverProfile.DriverProfileId);
        if (d == null) return;

        d.InterviewDate = interviewDate;
        await db.SaveChangesAsync();
        await Load();
    }

    private async Task Load()
    {
        isLoading = true;

        user = await db.Users.AsNoTracking().FirstOrDefaultAsync(u => u.Id == UserId);
        if (user == null)
        {
            isLoading = false;
            return;
        }

        role = "Unknown";
        if (await userManager.IsInRoleAsync(user, "Passenger")) role = "Passenger";
        else if (await userManager.IsInRoleAsync(user, "Driver")) role = "Driver";
        else if (await userManager.IsInRoleAsync(user, "Staff")) role = "Staff";

        passengerProfile = await db.PassengerProfiles.AsNoTracking().FirstOrDefaultAsync(p => p.UserId == UserId);
        driverProfile = await db.DriverProfiles.AsNoTracking().FirstOrDefaultAsync(d => d.UserId == UserId);

        displayName = passengerProfile?.FullName ?? driverProfile?.FullName ?? (user.Email ?? "");
        phone = passengerProfile?.ContactNumber ?? driverProfile?.ContactNumber ?? "";

        interviewDate = driverProfile?.InterviewDate;

        isLoading = false;
    }

    private void Back()
    {
        if (nav.Uri.Contains("from=verifydrivers"))
            nav.NavigateTo("/staff/verifydrivers");
        else
            nav.NavigateTo("/staff/manageusers");
    }
}
