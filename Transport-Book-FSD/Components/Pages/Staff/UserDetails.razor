@page "/staff/userdetails/{UserId}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Policy = "Staff2FA")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>User Details</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading user...</p>
}
else if (user == null)
{
    <p>User not found.</p>
    <button class="btn btn-outline-dark" @onclick="Back">Back</button>
}
else
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-12 col-md-6">
                    <div class="fw-bold">Email</div>
                    <div>@(user.Email ?? "")</div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="fw-bold">Role</div>
                    <div>@role</div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="fw-bold">Name</div>
                    <div>@displayName</div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="fw-bold">Phone</div>
                    <div>@phone</div>
                </div>
            </div>
        </div>
    </div>

    @if (role == "Passenger")
    {
        <h5>Passenger Profile</h5>
        @if (passengerProfile == null)
        {
            <p>No passenger profile record found.</p>
        }
        else
        {
            <table class="table table-bordered">
                <tbody>
                    <tr><th style="width:220px;">Gender</th><td>@passengerProfile.Gender</td></tr>
                    <tr><th>Date of Birth</th><td>@(passengerProfile.DateOfBirth?.ToString("dd/MM/yyyy") ?? "")</td></tr>
                    <tr><th>Address</th><td>@passengerProfile.ResidentialAddress</td></tr>
                    <tr><th>Emergency Contact</th><td>@passengerProfile.EmergencyContact</td></tr>
                    <tr><th>Total Completed Trips</th><td>@passengerProfile.TotalCompletedTrips</td></tr>
                    <tr><th>Penalty Balance</th><td>@passengerProfile.CancellationPenaltyBalance.ToString("0.00")</td></tr>
                </tbody>
            </table>
        }
    }
    else if (role == "Driver")
    {
        <h5>Driver Profile</h5>
        @if (driverProfile == null)
        {
            <p>No driver profile record found.</p>
        }
        else
        {
            <div class="mb-3" style="max-width:320px;">
                <label class="form-label fw-bold">Interview Date</label>
                <InputDate TValue="DateTime ?" class="form-control" @bind-Value="interviewDate" />
                <button class="btn btn-sm btn-outline-dark mt-2" @onclick="SaveInterviewDate">Save</button>
            </div>

            <table class="table table-bordered">
                <tbody>
                    <tr><th style="width:220px;">Gender</th><td>@driverProfile.Gender</td></tr>
                    <tr><th>Date of Birth</th><td>@(driverProfile.DateOfBirth?.ToString("dd/MM/yyyy") ?? "")</td></tr>
                    <tr><th>Interview Date</th><td>@(driverProfile.InterviewDate?.ToString("dd/MM/yyyy") ?? "")</td></tr>
                    <tr><th>Vehicle Type</th><td>@driverProfile.VehicleType</td></tr>
                    <tr><th>Vehicle Model</th><td>@driverProfile.VehicleModel</td></tr>
                    <tr><th>Vehicle Plate</th><td>@driverProfile.VehiclePlate</td></tr>
                    <tr><th>License Number</th><td>@driverProfile.LicenseNumber</td></tr>
                    <tr><th>Total Completed Trips</th><td>@driverProfile.TotalCompletedTrips</td></tr>
                    <tr><th>Total Earnings</th><td>@driverProfile.TotalEarnings.ToString("0.00")</td></tr>
                    <tr><th>Rating</th><td>@driverProfile.Rating.ToString("0.0")</td></tr>
                    <tr><th>Verification Status</th><td>@GetStatusText(driverProfile.VerificationStatus)</td></tr>
                    <tr><th>Verification Remarks</th><td>@(string.IsNullOrWhiteSpace(driverProfile.VerificationRemarks) ? "-" : driverProfile.VerificationRemarks)</td></tr>
                    <tr><th>Verified At</th><td>@(driverProfile.VerifiedAt.HasValue? driverProfile.VerifiedAt.Value.ToString("dd/MM/yyyy HH:mm") : "-")</td></tr>
                </tbody>
            </table>

            @if (GetStatusText(driverProfile.VerificationStatus) == "Pending")
            {
                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="mb-3">Verification Decision</h5>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Checklist</label>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="chkLicenseClear" id="chk1" />
                                <label class="form-check-label" for="chk1">License number is clear and readable</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="chkPlateMatches" id="chk2" />
                                <label class="form-check-label" for="chk2">Vehicle plate matches the submitted details</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="chkVehicleInfo" id="chk3" />
                                <label class="form-check-label" for="chk3">Vehicle type and model are provided</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="chkContactValid" id="chk4" />
                                <label class="form-check-label" for="chk4">Contact number is valid</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="chkVehicleSafe" id="chk4" />
                                <label class="form-check-label" for="chk4">Drivers vehicle is safe and reliable</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="chkInfoConsistent" id="chk5" />
                                <label class="form-check-label" for="chk5">All information is consistent (no mismatch)</label>
                            </div>
                        </div>

                        <div class="mb-3" style="max-width: 700px;">
                            <label class="form-label fw-bold">Remarks (optional)</label>
                            <input class="form-control" @bind="remarks"
                                   placeholder="e.g. License unclear, please re-upload" />
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-dark" @onclick="ApproveDriver">
                                Approve
                            </button>

                            <button class="btn btn-outline-dark" @onclick="RejectDriver">
                                Reject
                            </button>
                        </div>

                    </div>
                </div>
            }
        }
    }

    <button class="btn btn-outline-dark mt-3" @onclick="Back">Back</button>
}

@code {
    //allows the page to receive data from the URL
    [Parameter] public string UserId { get; set; } = "";
    
    //Controls what the UI shows
    private bool isLoading = true;
    private string? msg;

    //Identity user and basic display fields
    private ApplicationUser? user;
    private string role = "";
    private string displayName = "";
    private string phone = "";

    //Passenger and Driver specific profile details
    private PassengerProfile? passengerProfile;
    private DriverProfile? driverProfile;

    //Staff sets this when interviewing a driver
    private DateTime? interviewDate;

    //editable staff inputs
    private string? remarks;

    // Checklist tick boxes
    private bool chkLicenseClear;
    private bool chkPlateMatches;
    private bool chkVehicleInfo;
    private bool chkContactValid;
    private bool chkInfoConsistent;
    private bool chkVehicleSafe;

    // Returns true only if all required checkboxes are ticked
    private bool AllChecked =>
        chkLicenseClear &&
        chkPlateMatches &&
        chkVehicleInfo &&
        chkContactValid &&
        chkInfoConsistent;

    protected override async Task OnParametersSetAsync()
    {
        await Load();
    }

    //Save staff-entered interview date into the driver's profile
    private async Task SaveInterviewDate()
    {
        // If there is no driver profile, nothing to save
        if (driverProfile == null) return;

        // re-loads the driver profile as a tracked entity
        var d = await db.DriverProfiles.FirstOrDefaultAsync(x => x.DriverProfileId == driverProfile.DriverProfileId);
        if (d == null) return;

        // updates the interview date
        d.InterviewDate = interviewDate;
        await db.SaveChangesAsync();
        await Load();
    }

    //Get the currently logged-in staff user's ID 
    private async Task<string> GetStaffUserId()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var u = await userManager.GetUserAsync(authState.User);
        return u?.Id ?? "";
    }
    // Approve a driver and record verification details
    private async Task ApproveDriver()
    {
        msg = null;

        // If not a driver, nothing to approve
        if (driverProfile == null) return;

        // Current staff user id
        var staffId = await GetStaffUserId();

        // Re-fetch tracked entity to update it
        var d = await db.DriverProfiles.FirstOrDefaultAsync(x => x.DriverProfileId == driverProfile.DriverProfileId);
        if (d == null) return;

        // Update verification fields
        d.VerificationStatus = "Approved";
        d.VerificationRemarks = (remarks ?? "").Trim();
        d.VerifiedAt = DateTime.Now;
        d.VerifiedByUserId = staffId;

        // Save to database
        await db.SaveChangesAsync();

        // Show confirmation and refresh UI
        msg = "Driver approved.";
        await Load();
    }

    // Reject a driver and record verification details
    private async Task RejectDriver()
    {
        msg = null;

        // If not a driver, nothing to reject
        if (driverProfile == null) return;

        // Current staff user id
        var staffId = await GetStaffUserId();

        // Re-fetch driver profile as tracked entity
        var d = await db.DriverProfiles.FirstOrDefaultAsync(x => x.DriverProfileId == driverProfile.DriverProfileId);
        if (d == null) return;

        // Update verification fields
        d.VerificationStatus = "Rejected";
        d.VerificationRemarks = (remarks ?? "").Trim();
        d.VerifiedAt = DateTime.Now;
        d.VerifiedByUserId = staffId;

        // Save to database
        await db.SaveChangesAsync();

        // Show confirmation and refresh UI
        msg = "Driver rejected.";
        await Load();
    }

    // Load user + profile data from database and prepare what to show on screen
    private async Task Load()
    {
        isLoading = true;

        // Load Identity user record
        user = await db.Users.AsNoTracking().FirstOrDefaultAsync(u => u.Id == UserId);
        if (user == null)
        {
            isLoading = false;
            return;
        }

        // Determine user's role
        role = "Unknown";
        if (await userManager.IsInRoleAsync(user, "Passenger")) role = "Passenger";
        else if (await userManager.IsInRoleAsync(user, "Driver")) role = "Driver";
        else if (await userManager.IsInRoleAsync(user, "Staff")) role = "Staff";

        // Load related profiles
        passengerProfile = await db.PassengerProfiles.AsNoTracking().FirstOrDefaultAsync(p => p.UserId == UserId);
        driverProfile = await db.DriverProfiles.AsNoTracking().FirstOrDefaultAsync(d => d.UserId == UserId);

        // Prefer profile name/phone if exists
        displayName = passengerProfile?.FullName ?? driverProfile?.FullName ?? (user.Email ?? "");
        phone = passengerProfile?.ContactNumber ?? driverProfile?.ContactNumber ?? "";

        // Load driver interview date + remarks if driver profile exists
        interviewDate = driverProfile?.InterviewDate;

        if (driverProfile != null)
            remarks = driverProfile.VerificationRemarks;

        // Reset checklist each time page loads
        chkLicenseClear = false;
        chkPlateMatches = false;
        chkVehicleInfo = false;
        chkContactValid = false;
        chkInfoConsistent = false;

        isLoading = false;
    }

    // Convert null/empty status to a friendly text
    private string GetStatusText(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return "Pending";
        return status;
    }

    // Navigate back to the correct staff list page, depending on where user came from
    private void Back()
    {
        if (nav.Uri.Contains("from=verifydrivers"))
            nav.NavigateTo("/staff/verifydrivers");
        else
            nav.NavigateTo("/staff/manageusers");
    }
}
