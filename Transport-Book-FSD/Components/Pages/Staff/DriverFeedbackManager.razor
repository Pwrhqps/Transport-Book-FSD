@page "/staff/driverfeedbacks"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Staff")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject Microsoft.JSInterop.IJSRuntime JS
@inject NavigationManager nav

<h3>Drivers & Ratings</h3>

<div class="mb-3">
    <label for="sortSelect">Sort by rating:</label>
    <select id="sortSelect" class="form-select" style="width:220px; display:inline-block; margin-left:8px;"
            @bind="SortOrder" @bind:after="OnSortOrderUpdated">
        <option value="desc">Highest → Lowest</option>
        <option value="asc">Lowest → Highest</option>
    </select>

    <button class="btn btn-secondary" @onclick="Reload" style="margin-left:12px;">Refresh</button>
</div>

@if (IsLoading)
{
    <p><em>Loading...</em></p>
}
else if (Drivers?.Any() != true)
{
    <p>No drivers found.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Driver</th>
                <th>Overall Rating</th>
                <th>Status</th>
                <th>Suspension Reason</th>
                <th>Suspended Until</th>
                <th style="width:180px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var d in Drivers)
            {
                <tr>
                    <td>@d.FullName</td>
                    <td>@d.Rating.ToString("0.00")</td>
                    <td>
                        @if (d.IsSuspended)
                        {
                            <strong class="text-danger">Suspended</strong>
                        }
                        else
                        {
                            <span>Active</span>
                        }
                </td>
                <td>@(string.IsNullOrWhiteSpace(d.SuspendedReason) ? "-" : d.SuspendedReason)</td>
                <td>
                    @(d.SuspendedUntil.HasValue
                                    ? d.SuspendedUntil.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                    : (d.IsSuspended ? "Permanent" : "-"))
            </td>
            <td style="width:260px;">
                @{
                            var detailsUrl = $"/staff/driverfeedbacks/{d.UserId}";

                        }

                        <button class="btn btn-sm btn-outline-dark me-2"
                                @onclick="@(() => nav.NavigateTo(detailsUrl))">
                            View Details
                        </button>

                        <button class="btn btn-sm @(d.IsSuspended ? "btn-success" : "btn-danger")"
                                disabled="@ProcessingIds.Contains(d.DriverProfileId)"
                                @onclick="() => OnActionClick(d)">
                            @if (ProcessingIds.Contains(d.DriverProfileId))
                            {
                                <span>Processing...</span>
                            }
                            else if (d.IsSuspended)
                            {
                                <span>Unsuspend</span>
                            }
                            else
                            {
                                <span>Suspend</span>
                            }
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@* Simple modal overlay to collect reason + duration for suspension *@
@if (ShowSuspendDialog && SelectedDriverForDialog != null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" style="display:block;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Suspend @SelectedDriverForDialog.FullName</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CancelSuspend"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Reason (optional)</label>
                        <input class="form-control" @bind="SuspendReason" placeholder="Enter reason" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <select class="form-select" @bind="SelectedDurationKey">
                            @foreach (var opt in DurationOptions)
                            {
                                <option value="@opt.Key">@opt.Label</option>
                            }
                        </select>
                        <div class="form-text">Choose how long the suspension should last.</div>
                    </div>

                    <div>
                        <strong>Preview:</strong>
                        <div>
                            @if (SelectedDurationDays.HasValue)
                            {
                                <span>Ends: @DateTime.UtcNow.AddDays(SelectedDurationDays.Value).ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                            }
                            else
                            {
                                <span>Permanent suspension</span>
                            }
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelSuspend">Cancel</button>
                    <button class="btn btn-danger" @onclick="ConfirmSuspendAsync">Confirm Suspend</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<DriverRow> Drivers = new();
    private bool IsLoading = true;
    private string SortOrder = "desc"; // "desc" or "asc"
    private HashSet<int> ProcessingIds = new();

    // suspend modal state
    private bool ShowSuspendDialog = false;
    private DriverRow? SelectedDriverForDialog;
    private string? SuspendReason;
    private string SelectedDurationKey = "7"; // default key

    private readonly List<(string Key, string Label, int? Days)> DurationOptions = new()
    {
        ("1", "1 day", 1),
        ("7", "7 days", 7),
        ("30", "30 days", 30),
        ("perm", "Permanent", null)
    };

    private int? SelectedDurationDays => DurationOptions.FirstOrDefault(o => o.Key == SelectedDurationKey).Days;

    protected override async Task OnInitializedAsync()
    {
        await LoadDriversAsync();
    }

    private async Task LoadDriversAsync()
    {
        IsLoading = true;

        try
        {
            // ✅ Phase B: compute average rating per driver using Booking.DriverUserId (Identity)
            var ratingsDict = await (
                from f in db.Feedbacks
                join b in db.Bookings on f.BookingId equals b.BookingId
                where !string.IsNullOrWhiteSpace(b.DriverUserId)
                group f by b.DriverUserId into g
                select new { DriverUserId = g.Key!, Avg = g.Average(x => x.Rating) }
            ).ToDictionaryAsync(x => x.DriverUserId, x => x.Avg);

            // DriverProfiles are identity-linked by UserId
            var drivers = await db.DriverProfiles.AsNoTracking().ToListAsync();

            Drivers = drivers.Select(d =>
            {
                // default: keep whatever is stored in DriverProfile.Rating (if any)
                double rating = d.Rating;

                if (!string.IsNullOrWhiteSpace(d.UserId) && ratingsDict.TryGetValue(d.UserId, out var avg))
                {
                    rating = Math.Round(avg, 2);
                }

                return new DriverRow
                {
                    DriverProfileId = d.DriverProfileId,
                    UserId = d.UserId,
                    FullName = d.FullName,
                    Rating = rating,
                    IsSuspended = d.IsSuspended,
                    SuspendedReason = string.IsNullOrWhiteSpace(d.SuspendedReason) ? null : d.SuspendedReason,
                    SuspendedUntil = d.SuspendedUntil
                };
            }).ToList();

            ApplySort();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading drivers: {ex.Message}");
            Drivers = new List<DriverRow>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private Task OnSortOrderUpdated()
    {
        ApplySort();
        return Task.CompletedTask;
    }

    private void ApplySort()
    {
        if (SortOrder == "asc")
            Drivers = Drivers.OrderBy(d => d.Rating).ThenBy(d => d.FullName).ToList();
        else
            Drivers = Drivers.OrderByDescending(d => d.Rating).ThenBy(d => d.FullName).ToList();
    }

    private Task Reload() => LoadDriversAsync();

    private void OnActionClick(DriverRow d)
    {
        if (d.IsSuspended)
        {
            _ = UnsuspendAsync(d);
        }
        else
        {
            SelectedDriverForDialog = d;
            SuspendReason = "";
            SelectedDurationKey = "7";
            ShowSuspendDialog = true;
        }
    }

    private async Task UnsuspendAsync(DriverRow driver)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to unsuspend {driver.FullName.Trim()}?");
        if (!ok) return;

        ProcessingIds.Add(driver.DriverProfileId);
        StateHasChanged();

        try
        {
            var entity = await db.DriverProfiles.FindAsync(driver.DriverProfileId);
            if (entity == null)
            {
                await JS.InvokeVoidAsync("alert", "Driver record not found.");
                return;
            }

            entity.IsSuspended = false;
            entity.SuspendedAt = null;
            entity.SuspendedUntil = null;
            entity.SuspendedReason = "";

            await db.SaveChangesAsync();

            driver.IsSuspended = false;
            driver.SuspendedReason = null;
            driver.SuspendedUntil = null;
            ApplySort();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Unsuspend failed: {ex.Message}");
        }
        finally
        {
            ProcessingIds.Remove(driver.DriverProfileId);
            StateHasChanged();
        }
    }

    private void CancelSuspend()
    {
        ShowSuspendDialog = false;
        SelectedDriverForDialog = null;
        SuspendReason = null;
    }

    private async Task ConfirmSuspendAsync()
    {
        if (SelectedDriverForDialog == null)
        {
            CancelSuspend();
            return;
        }

        ProcessingIds.Add(SelectedDriverForDialog.DriverProfileId);
        StateHasChanged();

        try
        {
            var entity = await db.DriverProfiles.FindAsync(SelectedDriverForDialog.DriverProfileId);
            if (entity == null)
            {
                await JS.InvokeVoidAsync("alert", "Driver record not found.");
                return;
            }

            entity.IsSuspended = true;
            entity.SuspendedAt = DateTime.UtcNow;
            entity.SuspendedReason = SuspendReason ?? "";

            var days = SelectedDurationDays;
            entity.SuspendedUntil = days.HasValue ? DateTime.UtcNow.AddDays(days.Value) : null;

            await db.SaveChangesAsync();

            SelectedDriverForDialog.IsSuspended = entity.IsSuspended;
            SelectedDriverForDialog.SuspendedReason = string.IsNullOrWhiteSpace(entity.SuspendedReason) ? null : entity.SuspendedReason;
            SelectedDriverForDialog.SuspendedUntil = entity.SuspendedUntil;

            ApplySort();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Suspend failed: {ex.Message}");
        }
        finally
        {
            ProcessingIds.Remove(SelectedDriverForDialog.DriverProfileId);
            CancelSuspend();
            StateHasChanged();
        }
    }

    private class DriverRow
    {
        public int DriverProfileId { get; set; }
        public string UserId { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public double Rating { get; set; }
        public bool IsSuspended { get; set; }
        public string? SuspendedReason { get; set; }
        public DateTime? SuspendedUntil { get; set; }
    }
}
