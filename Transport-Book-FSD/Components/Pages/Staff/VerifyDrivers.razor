@page "/staff/verifydrivers"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Policy = "Staff2FA")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>Verify Drivers</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

<div class="mb-3">
    <label class="form-label fw-bold">Filter</label>
    <select class="form-select" @bind="filter" @bind:after="OnFilterChanged">
        <option value="Pending">Pending</option>
        <option value="Rejected">Rejected</option>
        <option value="Approved">Approved</option>
        <option value="All">All</option>
    </select>
</div>

@if (isLoading)
{
    <p>Loading drivers...</p>
}
else if (drivers.Count == 0)
{
    <p>No drivers found for this filter.</p>
}
else
{
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Driver</th>
                <th>Contact</th>
                <th>Vehicle Plate</th>
                <th>License No.</th>
                <th>Status</th>
                <th style="width:160px;">Action</th>
            </tr>
        </thead>
        <tbody>
            @{
                int row = 1;
            }
            @foreach (var d in drivers)
            {
                <tr>
                    <td>@row</td>
                    <td>@d.FullName</td>
                    <td>@d.ContactNumber</td>
                    <td>@d.VehiclePlate</td>
                    <td>@d.LicenseNumber</td>
                    <td>@GetStatusText(d.VerificationStatus)</td>
                    <td>
                        <button class="btn btn-sm btn-outline-dark"
                                @onclick="() => OpenUserDetails(d.UserId)">
                            Open
                        </button>
                    </td>
                </tr>
                row++;
            }
        </tbody>
    </table>
}

@code {
    private bool isLoading = true;
    private string filter = "Pending";
    private string? msg;

    private List<DriverProfile> drivers = new();

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    protected override async Task OnParametersSetAsync()
    {
        await Load();
    }

    private async Task OnFilterChanged()
    {
        await Load();
    }

    private async Task Load()
    {
        isLoading = true;

        var q = db.DriverProfiles.AsQueryable();

        if (filter != "All")
        {
            if (filter == "Pending")
            {
                q = q.Where(d => d.VerificationStatus == "" || d.VerificationStatus == null || d.VerificationStatus == "Pending");
            }
            else
            {
                q = q.Where(d => d.VerificationStatus == filter);
            }
        }

        drivers = await q
            .OrderByDescending(d => d.DriverProfileId)
            .ToListAsync();

        isLoading = false;
    }

    private string GetStatusText(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return "Pending";
        return status;
    }

    private void OpenUserDetails(string userId)
    {
        nav.NavigateTo($"/staff/userdetails/{userId}?from=verifydrivers");
    }
}
