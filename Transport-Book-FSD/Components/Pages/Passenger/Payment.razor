@page "/passenger/payment"
@page "/passenger/payment/{PreselectId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@using PaymentModel = TransportBookFSD.Models.Payment
@attribute [Authorize(Roles = "Passenger")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>Payment</h3>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading outstanding payments...</p>
}
else
{
    @if (pendingCashItems.Count > 0)
    {
        <div class="alert alert-warning">
            <b>Pending Cash Payments</b><br />
            You have cash payments waiting for driver/staff confirmation. These items cannot be paid again.
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Pending Cash Items</h5>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Booking</th>
                                <th>Status</th>
                                <th>Pickup</th>
                                <th>Fare</th>
                                <th>Payment Ref</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in pendingCashItems)
                            {
                                <tr>
                                    <td>#@b.BookingId</td>
                                    <td>@b.Status</td>
                                    <td>@b.PickupDateTime.ToString("dd MMM yyyy, HH:mm")</td>
                                    <td>$@b.Fare.ToString("0.00")</td>
                                    <td>@(b.Payment?.ReferenceNo ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="form-text">
                    Once confirmed, these bookings will be marked as paid automatically.
                </div>
            </div>
        </div>
    }

    @if (items.Count == 0)
    {
        <p>No outstanding payments.</p>
        <button class="btn btn-outline-dark" @onclick="Back">Back to My Bookings</button>
    }
    else
    {
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Pay Outstanding Items</h5>

                <div class="mb-2">
                    <div><b>Transport Balance:</b> $@transportBalance.ToString("0.00")</div>
                    <div class="form-text">Top up from Passenger Home (Card only).</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Payment Method</label>
                    <select class="form-select" @bind="paymentMethod">
                        <option value="Balance">Transport Balance</option>
                        <option value="Cash">Cash (Pending Confirmation)</option>
                    </select>

                    @if (paymentMethod == "Cash")
                    {
                        <div class="form-text mt-1">
                            Cash payments are recorded as <b>Pending</b> until the driver confirms cash received.
                            If you selected bookings from different drivers, the system will create separate pending cash records (one per driver).
                        </div>
                    }
                </div>

                <div class="mb-2">
                    <button class="btn btn-outline-dark btn-sm me-2" @onclick="SelectAll">Select All</button>
                    <button class="btn btn-outline-dark btn-sm" @onclick="ClearAll">Clear</button>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th style="width:40px;"></th>
                                <th>Booking</th>
                                <th>Status</th>
                                <th>Pickup</th>
                                <th>Fare</th>
                                <th>Driver</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var it in items)
                            {
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input"
                                               @bind="it.IsSelected" />
                                    </td>
                                    <td>#@it.Booking.BookingId</td>
                                    <td>@it.Booking.Status</td>
                                    <td>@it.Booking.PickupDateTime.ToString("dd MMM yyyy, HH:mm")</td>
                                    <td>$@it.Booking.Fare.ToString("0.00")</td>
                                    <td>@(string.IsNullOrWhiteSpace(it.Booking.DriverUserId) ? "-" : "Assigned")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <div><b>Selected Items:</b> @SelectedCount</div>
                    <div><b>Total:</b> $@SelectedTotal.ToString("0.00")</div>
                </div>

                @if (!string.IsNullOrEmpty(payError))
                {
                    <div class="alert alert-danger mt-3">@payError</div>
                }

                <div class="mt-3">
                    <button class="btn btn-dark" @onclick="PaySelected" disabled="@(!CanPay)">
                        @(paymentMethod == "Cash" ? "Create Cash Payment (Pending)" : "Pay with Balance")
                    </button>
                    <button class="btn btn-outline-dark ms-2" @onclick="Back">Back</button>
                </div>
            </div>
        </div>

        @if (lastPayments.Count > 0)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Payment Record(s)</h5>

                    @foreach (var p in lastPayments)
                    {
                        <div class="mb-3">
                            <div><b>Reference:</b> @p.ReferenceNo</div>
                            <div><b>Method:</b> @p.Method</div>
                            <div><b>Status:</b> @p.Status</div>
                            <div><b>Amount:</b> $@p.TotalAmount.ToString("0.00")</div>
                            <div><b>Items:</b> @p.ItemCount</div>
                            <div><b>Created:</b> @p.CreatedAt.ToString("dd MMM yyyy, HH:mm")</div>

                            @if (p.CompletedAt != null)
                            {
                                <div><b>Completed:</b> @p.CompletedAt.Value.ToString("dd MMM yyyy, HH:mm")</div>
                            }

                            <hr />
                        </div>
                    }

                    <div class="form-text">
                        For cash payments: the driver will confirm and then the booking(s) will be marked as paid.
                    </div>
                </div>
            </div>
        }
    }
}

@code {
    // Optional preselect booking ID from URL: if provided, auto-select that booking in the payment list
    [Parameter] public int? PreselectId { get; set; }

    // Booking data + checkbox state for multi-select payment
    class PayItem
    {
        public Booking Booking { get; set; } = new Booking();
        public bool IsSelected { get; set; }
    }

    bool isLoading = true;
    string msg = "";
    string payError = "";

    string paymentMethod = "Balance"; // "Balance" or "Cash"

    List<PayItem> items = new();
    List<Booking> pendingCashItems = new();

    PassengerProfile? profile;
    decimal transportBalance = 0m;

    List<PaymentModel> lastPayments = new();

    int SelectedCount => items.Count(x => x.IsSelected); // number of checked items
    decimal SelectedTotal => items.Where(x => x.IsSelected).Sum(x => x.Booking.Fare); // sum of fares selected
    bool CanPay => SelectedCount > 0 && SelectedTotal > 0m;  // enable Pay button

    protected override async Task OnInitializedAsync()
    {
        // Load all payment page data
        await LoadAll();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload if URL parameter changes
        await LoadAll();
    }

    async Task LoadAll()
    {
        isLoading = true;
        msg = "";
        payError = "";
        lastPayments = new();

        // Identify current passenger
        var auth = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(auth.User);
        if (user == null)
        {
            msg = "User not found.";
            isLoading = false;
            return;
        }

        // Load wallet balance for display and balance-payment validation
        profile = await db.PassengerProfiles.FirstOrDefaultAsync(p => p.UserId == user.Id);
        transportBalance = profile?.TransportBalance ?? 0m;

        // Outstanding = unpaid, not already in a pending cash payment
        var outstanding = await db.Bookings
            .Include(b => b.Payment)
            .Where(b =>
                b.PassengerUserId == user.Id &&
                !b.IsPaid &&
                (b.PaymentId == null || b.Payment!.Status != "Pending") &&
                (
                    b.Status == "Completed" ||
                    (b.Status == "Cancelled" && b.Fare == 2.00m)
                )
            )
            .OrderBy(b => b.PickupDateTime)
            .ThenBy(b => b.BookingId)
            .ToListAsync();

        // Convert bookings into selectable UI items
        items = outstanding.Select(b => new PayItem { Booking = b }).ToList();

        // Shows bookings already awaiting driver cash confirmation
        pendingCashItems = await db.Bookings
            .Include(b => b.Payment)
            .Where(b =>
                b.PassengerUserId == user.Id &&
                !b.IsPaid &&
                b.PaymentId != null &&
                b.Payment!.Method == "Cash" &&
                b.Payment.Status == "Pending"
            )
            .OrderBy(b => b.PickupDateTime)
            .ThenBy(b => b.BookingId)
            .ToListAsync();

        // Auto-select booking when coming from My Bookings
        if (PreselectId != null)
        {
            var target = items.FirstOrDefault(x => x.Booking.BookingId == PreselectId.Value);
            if (target != null) target.IsSelected = true;
        }

        isLoading = false;
    }

    void SelectAll()
    {
        foreach (var it in items) it.IsSelected = true;
    }

    void ClearAll()
    {
        foreach (var it in items) it.IsSelected = false;
        payError = "";
    }

    string MakeRef()
    {
        // Generate unique reference number for Payment / WalletTransaction
        return "TP" + DateTime.Now.ToString("yyyyMMddHHmmssfff");
    }

    async Task PaySelected()
    {
        payError = "";
        msg = "";
        lastPayments = new();

        // Collect selected bookings
        var selected = items.Where(x => x.IsSelected).Select(x => x.Booking).ToList();
        if (selected.Count == 0)
        {
            payError = "Please select at least one item.";
            return;
        }

        // Validate total amount
        var totalAll = selected.Sum(b => b.Fare);
        if (totalAll <= 0m)
        {
            payError = "Total must be more than $0.";
            return;
        }

        // Re-check passenger identity
        var auth = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(auth.User);
        if (user == null)
        {
            payError = "User not found.";
            return;
        }

        // Load profile for wallet operations (Balance payment)
        profile = await db.PassengerProfiles.FirstOrDefaultAsync(p => p.UserId == user.Id);
        if (profile == null)
        {
            payError = "Profile not found.";
            return;
        }

        var now = DateTime.Now;

        if (paymentMethod == "Balance")
        {
            // Balance payment requires sufficient TransportBalance
            if (profile.TransportBalance < totalAll)
            {
                payError = "Insufficient transport balance. Please top up from Home.";
                return;
            }

            // Create ONE succeeded payment record for all selected items
            var refNo = MakeRef();

            var payment = new PaymentModel
            {
                PassengerUserId = user.Id,
                TotalAmount = totalAll,
                ItemCount = selected.Count,
                Method = "Balance",
                Status = "Succeeded",
                ReferenceNo = refNo,
                CreatedAt = now,
                CompletedAt = now
            };

            db.Payments.Add(payment);
            await db.SaveChangesAsync();

            // Link each booking to the payment and mark as paid
            foreach (var b in selected)
            {
                b.PaymentId = payment.PaymentId;
                b.IsPaid = true;
                b.PaidAt = now;
            }

            // Deduct wallet balance
            profile.TransportBalance -= totalAll;

            // Record wallet transaction for history
            db.WalletTransactions.Add(new WalletTransaction
            {
                UserId = user.Id,
                Amount = -totalAll,
                Type = "RidePayment",
                Method = "Balance",
                ReferenceNo = refNo
            });

            await db.SaveChangesAsync();

            lastPayments.Add(payment);
            msg = "Payment successful using Transport Balance.";
        }
        else
        {
            // Completed rides must have a driver for cash confirmation
            var invalid = selected.Where(b => b.Status == "Completed" && string.IsNullOrWhiteSpace(b.DriverUserId)).ToList();
            if (invalid.Count > 0)
            {
                payError = "Some completed rides do not have an assigned driver. Cash payment cannot be created for those items.";
                return;
            }

            // Split by DriverUserId so each driver confirms only their own cash payment
            var groups = selected
                .GroupBy(b => string.IsNullOrWhiteSpace(b.DriverUserId) ? "NO_DRIVER" : b.DriverUserId!)
                .ToList();

            foreach (var grp in groups)
            {
                var list = grp.ToList();
                var groupTotal = list.Sum(b => b.Fare);

                var refNo = MakeRef();

                // Create a Pending cash payment for this driver
                var payment = new PaymentModel
                {
                    PassengerUserId = user.Id,
                    TotalAmount = groupTotal,
                    ItemCount = list.Count,
                    Method = "Cash",
                    Status = "Pending",
                    ReferenceNo = refNo,
                    CreatedAt = now
                };

                db.Payments.Add(payment);
                await db.SaveChangesAsync(); // get payment id

                foreach (var b in list)
                {
                    b.PaymentId = payment.PaymentId;
                    // cash is pending: do NOT mark IsPaid here
                }

                await db.SaveChangesAsync();

                lastPayments.Add(payment);
            }

            msg = "Cash payment record(s) created (Pending). Please pay the driver. Payment will complete after confirmation.";
        }

        await LoadAll();
    }

    void Back()
    {
        nav.NavigateTo("/passenger/mybookings");
    }
}
