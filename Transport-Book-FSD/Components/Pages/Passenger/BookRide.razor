@page "/passenger/book"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Passenger")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>Book a Ride</h3>

<EditForm Model="form" OnValidSubmit="SubmitBooking">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Pickup Location</label>
        <InputText class="form-control" @bind-Value="form.PickupLocation" />
    </div>

    <div class="mb-3">
        <label class="form-label">Dropoff Location</label>
        <InputText class="form-control" @bind-Value="form.DropoffLocation" />
    </div>

    <div class="mb-3">
        <label class="form-label">Pickup Date & Time</label>
        <InputText class="form-control" type="datetime-local" @bind-Value="pickupLocal" />
        <div class="form-text">Leave as default if you want ASAP.</div>
    </div>

    <button class="btn btn-dark" type="submit">Confirm Booking</button>
    <button class="btn btn-outline-dark ms-2" type="button" @onclick="GoMyBookings">View My Bookings</button>
</EditForm>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="mt-3 alert alert-info">@msg</div>
}

@code {
    private BookingForm form = new();
    private string pickupLocal = DateTime.Now.ToString("yyyy-MM-ddTHH:mm");
    private string? msg;

    private async Task SubmitBooking()
    {
        msg = null;

        // Identify current passenger using Identity (prevents creating bookings without login)
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);
        if (user == null)
        {
            msg = "Unable to identify passenger. Please login again.";
            return;
        }

        //Suspended passengers cannot create new bookings
        var profile = db.PassengerProfiles.FirstOrDefault(p => p.UserId == user.Id);
        if (profile != null && profile.IsSuspended)
        {
            // auto-reactivate if suspension has expired
            if (profile.SuspendedUntil.HasValue && profile.SuspendedUntil.Value <= DateTime.Now)
            {
                profile.IsSuspended = false;
                profile.SuspendedReason = "";
                profile.SuspendedUntil = null;
                profile.SuspendedAt = null;
                db.SaveChanges();
            }
            else
            {
                // Show clear message: until when + reason (if available)
                var untilText = profile.SuspendedUntil.HasValue
                    ? profile.SuspendedUntil.Value.ToString("dd MMM yyyy, HH:mm")
                    : "until further notice";

                var reasonText = string.IsNullOrWhiteSpace(profile.SuspendedReason)
                    ? "No reason provided."
                    : profile.SuspendedReason;

                msg = $"Your account is suspended ({untilText}). Reason: {reasonText}";
                return;
            }
        }

        // Convert the datetime-local string into DateTime
        DateTime pickupDateTime = DateTime.Now;
        if (!string.IsNullOrWhiteSpace(pickupLocal))
        {
            DateTime.TryParse(pickupLocal, out pickupDateTime);
        }

        // Fare is calculated based on pickup, dropoff, and time (Rule in FareCalculator)
        decimal fare = FareCalculator.CalculateFare(form.PickupLocation, form.DropoffLocation, pickupDateTime);

        // Create booking record linked to passenger via Identity user id
        var booking = new Booking
        {
            PassengerUserId = user.Id,

            // Trim inputs for cleaner data storage
            PickupLocation = form.PickupLocation.Trim(),
            DropoffLocation = form.DropoffLocation.Trim(),
            PickupDateTime = pickupDateTime,
            Status = "Pending",
            Fare = fare
        };

        //Save Booking to Database
        db.Bookings.Add(booking);
        await db.SaveChangesAsync();

        // Redirect to booking list after success
        nav.NavigateTo("/passenger/mybookings", true);
    }

    private void GoMyBookings()
    {
        // Redirect to booking list after success
        nav.NavigateTo("/passenger/mybookings");
    }

    private class BookingForm
    {
        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(120)]
        public string PickupLocation { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(120)]
        public string DropoffLocation { get; set; } = "";
    }
}
