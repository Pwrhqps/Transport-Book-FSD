@page "/passenger/mybookings"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@using Transport_Book_FSD.Data
@using Transport_Book_FSD.Models
@attribute [Authorize(Roles = "Passenger")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav
@inject IJSRuntime JS

<h3>My Bookings</h3>

<button class="btn btn-dark mb-3" @onclick="GoBook">+ Book Another Ride</button>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading bookings...</p>
}
else if (bookings.Count == 0)
{
    <p>No bookings yet.</p>
}
else
{
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Pickup</th>
                <th>Dropoff</th>
                <th>Pickup Time</th>
                <th>Status</th>
                <th>Fare</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @{
                int row = 1;
            }
            @foreach (var b in bookings)
            {
                <tr>
                    <td>@row</td>
                    <td>@b.PickupLocation</td>
                    <td>@b.DropoffLocation</td>
                    <td>@b.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@b.Status</td>
                    <td>@b.Fare.ToString("0.00")</td>
                    <td>
                        @if (b.Status == "Pending" || b.Status == "Accepted")
                        {
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => ConfirmCancel(b.BookingId)">
                                Cancel
                            </button>
                        }
                        else if (b.Status == "Cancelled" && b.Fare == 2.00m && !b.IsPaid)
                        {
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => GoPayment(b.BookingId)">
                                To Payment
                            </button>
                        }
                        else if (b.Status == "Cancelled" && !b.IsPaid)
                        {
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="() => ConfirmDelete(b.BookingId)">
                                Delete
                            </button>
                        }
                        else if (b.Status == "Completed" && !b.IsPaid)
                        {
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => GoPayment(b.BookingId)">
                                To Payment
                            </button>
                        }
                        else if ((b.Status == "Completed" || b.Status == "Cancelled") && b.IsPaid)
                        {
                            <span class="text-success fw-bold">Paid</span>
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                </tr>
                row++;
            }
        </tbody>
    </table>
}

@code {
    private bool isLoading = true;
    private List<Booking> bookings = new();
    private string? msg;

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private void GoBook()
    {
        nav.NavigateTo("/passenger/book");
    }

    private void GoPayment(int bookingId)
    {
        nav.NavigateTo($"/passenger/payment/{bookingId}");
    }

    private async Task LoadBookings()
    {
        isLoading = true;

        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = await userManager.GetUserAsync(authState.User);

        if (user == null)
        {
            bookings = new List<Booking>();
            isLoading = false;
            return;
        }

        var passenger = db.Passengers.FirstOrDefault(p => p.UserId == user.Id);

        if (passenger == null)
        {
            bookings = new List<Booking>();
            isLoading = false;
            return;
        }

        bookings = db.Bookings
            .Where(b => b.PassengerId == passenger.PassengerId &&
                   !(b.IsPaid && (b.Status == "Completed" || (b.Status == "Cancelled" && b.Fare == 2.00m))))
            .OrderByDescending(b => b.PickupDateTime)
            .ThenByDescending(b => b.BookingId)
            .ToList();

        isLoading = false;
    }

    private async Task ConfirmCancel(int bookingId)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to cancel this booking?");
        if (!ok) return;

        await CancelBooking(bookingId);
    }

    private async Task ConfirmDelete(int bookingId)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", "Delete this booking? This cannot be undone.");
        if (!ok) return;

        await DeleteBooking(bookingId);
    }

    private async Task CancelBooking(int bookingId)
    {
        msg = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Unable to cancel booking. Please login again.";
            return;
        }

        var passenger = db.Passengers.FirstOrDefault(p => p.UserId == user.Id);
        if (passenger == null)
        {
            msg = "Passenger record not found.";
            return;
        }

        var booking = db.Bookings.FirstOrDefault(b => b.BookingId == bookingId && b.PassengerId == passenger.PassengerId);
        if (booking == null)
        {
            msg = "Booking not found.";
            return;
        }

        if (booking.Status == "Completed" || booking.Status == "Cancelled")
        {
            msg = "This booking cannot be cancelled.";
            return;
        }

        if (booking.Status == "Pending")
        {
            booking.Status = "Cancelled";
            booking.Fare = 0.00m;

            await db.SaveChangesAsync();

            msg = $"Booking cancelled.";
            await LoadBookings();
            return;
        }

        if (booking.Status == "Accepted")
        {
            booking.Status = "Cancelled";
            booking.Fare = 2.00m;

            await db.SaveChangesAsync();

            msg = $"Booking cancelled. $2 penalty is payable.";
            await LoadBookings();
            return;
        }

        msg = "This booking cannot be cancelled.";
    }

    private async Task DeleteBooking(int bookingId)
    {
        msg = null;

        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Unable to delete booking. Please login again.";
            return;
        }

        var passenger = db.Passengers.FirstOrDefault(p => p.UserId == user.Id);
        if (passenger == null)
        {
            msg = "Passenger record not found.";
            return;
        }

        var booking = db.Bookings.FirstOrDefault(b => b.BookingId == bookingId && b.PassengerId == passenger.PassengerId);
        if (booking == null)
        {
            msg = "Booking not found.";
            return;
        }

        if (booking.Status != "Cancelled")
        {
            msg = "Only cancelled bookings can be deleted.";
            return;
        }

        if (booking.Fare == 2.00m && !booking.IsPaid)
        {
            msg = "Penalty bookings must be paid before deletion.";
            return;
        }

        db.Bookings.Remove(booking);
        await db.SaveChangesAsync();

        msg = "Cancelled booking deleted.";
        await LoadBookings();
    }

    private async Task<ApplicationUser?> GetCurrentUser()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;
        return await userManager.GetUserAsync(principal);
    }
}
