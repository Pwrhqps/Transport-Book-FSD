@page "/passenger/profile"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Passenger")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>My Profile</h3>
<p>Update your personal information.</p>

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (isLoading)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="form" OnValidSubmit="Save">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Personal Details -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Personal Details</h5>

                <div class="mb-3">
                    <label class="form-label fw-bold">Full Name</label>
                    <InputText class="form-control" @bind-Value="form.FullName" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Email</label>
                    <input class="form-control" value="@email" disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Gender</label>
                    <InputSelect class="form-select" @bind-Value="form.Gender">
                        <option value="">-- Select --</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Date of Birth</label>
                    <InputDate class="form-control" @bind-Value="form.DateOfBirth" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Residential Address</label>
                    <InputText class="form-control" @bind-Value="form.ResidentialAddress" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Emergency Contact</label>
                    <InputText class="form-control" @bind-Value="form.EmergencyContact" />
                </div>
            </div>
        </div>

        <!-- Contact Number (Verified by Password) -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Contact Number</h5>
                <p class="text-muted mb-2">
                    Changing your contact number requires your current password.
                </p>

                <div class="mb-2">
                    <label class="form-label fw-bold">Contact Number (8 digits)</label>
                    @* IMPORTANT: bind to form.ContactNumber (NOT the EF tracked entity) *@
                    <InputText class="form-control"
                               @bind-Value="form.ContactNumber"
                               placeholder="e.g. 91234567" />
                </div>

                <div class="mb-2">
                    <label class="form-label fw-bold">Current Password</label>
                    <input class="form-control" type="password" @bind="currentPassword" />
                </div>
            </div>
        </div>

        <!-- Stats & Wallet (read-only from DB entity) -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Stats & Wallet</h5>

                <div class="mb-2">
                    <label class="form-label fw-bold">Transport Balance</label>
                    <input class="form-control" value="@profile.TransportBalance.ToString("0.00")" disabled />
                    <div class="form-text">Top up from Home. Used for ride payments.</div>
                </div>

                <div class="mb-2">
                    <label class="form-label fw-bold">Cancellation Penalty Balance</label>
                    <input class="form-control" value="@profile.CancellationPenaltyBalance.ToString("0.00")" disabled />
                </div>

                @if (profile.IsSuspended)
                {
                    <div class="alert alert-danger mt-3">
                        <b>Account Suspended</b><br />
                        Reason: @profile.SuspendedReason<br />
                        @if (profile.SuspendedUntil != null)
                        {
                            <span>Until: @profile.SuspendedUntil.Value.ToString("dd MMM yyyy")</span>
                        }
                    </div>
                }
            </div>
        </div>

        <button type="submit" class="btn btn-dark">Update Profile</button>
        <button type="button" class="btn btn-outline-dark ms-2" @onclick="Back">Back</button>
    </EditForm>
}

@code {
    private PassengerProfile profile = new PassengerProfile();
    private PassengerForm form = new PassengerForm();

    private bool isLoading = true;
    private string msg = "";
    private string email = "";

    // Phone update verification
    private string currentPassword = "";

    private class PassengerForm
    {
        // Required basic profile fields
        [Required]
        public string FullName { get; set; } = "";

        [Required]
        public string ContactNumber { get; set; } = "";

        // Optional personal details
        public string Gender { get; set; } = "";
        public DateTime? DateOfBirth { get; set; } = new DateTime(2000, 1, 1);
        public string ResidentialAddress { get; set; } = "";
        public string EmergencyContact { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        msg = "";

        // Retrieve authenticated user
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        var user = await userManager.GetUserAsync(principal);
        if (user == null)
        {
            msg = "User not found.";
            isLoading = false;
            return;
        }

        // Get email for display
        email = principal.FindFirstValue(ClaimTypes.Email) ?? user.Email ?? "";

        // Load passenger profile from database
        var existing = db.PassengerProfiles.FirstOrDefault(p => p.UserId == user.Id);
        if (existing == null)
        {
            // Auto-create profile if missing
            profile = new PassengerProfile
            {
                UserId = user.Id,
                FullName = "",
                ContactNumber = "",
                Gender = "",
                DateOfBirth = new DateTime(2000, 1, 1),
                ResidentialAddress = "",
                EmergencyContact = "",
                TotalCompletedTrips = 0,
                TransportBalance = 0m,
                CancellationPenaltyBalance = 0m
            };

            db.PassengerProfiles.Add(profile);
            await db.SaveChangesAsync();
        }
        else
        {
            profile = existing;
        }

        // Copy DB -> form (so UI edits do NOT directly modify EF tracked entity)
        form.FullName = profile.FullName ?? "";
        form.ContactNumber = profile.ContactNumber ?? "";
        form.Gender = profile.Gender ?? "";
        form.DateOfBirth = profile.DateOfBirth;
        form.ResidentialAddress = profile.ResidentialAddress ?? "";
        form.EmergencyContact = profile.EmergencyContact ?? "";

        isLoading = false;
    }

    // Singapore phone number (8 digits only)
    private bool IsValidSgPhone(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return false;
        s = s.Trim();
        return s.Length == 8 && s.All(char.IsDigit);
    }

    private async Task Save()
    {
        msg = "";

        // Re-check authenticated user before saving
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;
        var user = await userManager.GetUserAsync(principal);

        if (user == null)
        {
            msg = "User not found.";
            return;
        }

        // Load tracked profile entity
        var existing = db.PassengerProfiles.FirstOrDefault(p => p.UserId == user.Id);
        if (existing == null)
        {
            msg = "Profile not found.";
            return;
        }

        // Normal fields (always allowed)
        existing.FullName = form.FullName;
        existing.Gender = form.Gender;
        existing.DateOfBirth = form.DateOfBirth;
        existing.ResidentialAddress = form.ResidentialAddress;
        existing.EmergencyContact = form.EmergencyContact;

        // Contact number change requires password
        var oldPhone = (existing.ContactNumber ?? "").Trim();
        var newPhone = (form.ContactNumber ?? "").Trim();

        if (newPhone != oldPhone)
        {
            if (!IsValidSgPhone(newPhone))
            {
                msg = "Contact number must be exactly 8 digits.";
                form.ContactNumber = oldPhone;
                return;
            }

            // Require current password
            if (string.IsNullOrWhiteSpace(currentPassword))
            {
                msg = "Please enter your current password to change contact number.";
                form.ContactNumber = oldPhone;
                return;
            }

            // Verify password using Identity
            var ok = await userManager.CheckPasswordAsync(user, currentPassword);
            if (!ok)
            {
                msg = "Incorrect password. Contact number not updated.";
                form.ContactNumber = oldPhone;
                return;
            }

            // Password verified -> update contact number
            existing.ContactNumber = newPhone;
            currentPassword = "";
        }

        await db.SaveChangesAsync();

        // Refresh local profile reference for read-only display values
        profile = existing;

        msg = "Profile updated.";
    }

    private void Back()
    {
        nav.NavigateTo("/passenger/home");
    }
}
