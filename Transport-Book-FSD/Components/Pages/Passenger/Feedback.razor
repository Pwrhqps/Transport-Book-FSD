@page "/passenger/feedback/{bookingId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using TransportBookFSD.Data
@using TransportBookFSD.Models
@attribute [Authorize(Roles = "Passenger")]

@inject AppDbContext db
@inject UserManager<ApplicationUser> userManager
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager nav

<h3>Ride Feedback</h3>

@* back button *@
<button class="btn btn-outline-dark mb-3" @onclick="Back">Back to Booking History</button>

@* shows a message whenever there is an error *@
@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert alert-info">@msg</div>
}


@if (isLoading)
{
    <p>Loading...</p>
}
else if (booking == null)
{
    <p>Booking not found.</p>
}
else
{
    <!-- Displays a receipt like card. -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Receipt</h5>
                <span class="text-muted">@receiptRef</span>
            </div>

            <hr />

            @* prints value from booking model *@
            <div class="row g-3">
                <div class="col-md-6">
                    <div><b>Pickup:</b> @booking.PickupLocation</div>
                    <div><b>Dropoff:</b> @booking.DropoffLocation</div>
                    <div><b>Pickup Time:</b> @booking.PickupDateTime.ToString("dd/MM/yyyy HH:mm")</div>
                    <div><b>Status:</b> @booking.Status</div>
                </div>

                <div class="col-md-6">
                    <div><b>Fare:</b> @booking.Fare.ToString("0.00")</div>
                    <div><b>Paid At:</b> @(booking.PaidAt.HasValue? booking.PaidAt.Value.ToString("dd/MM/yyyy HH:mm") : "-")</div>
                    <div><b>Payment Status:</b> @(booking.PaidAt.HasValue ? "Paid" : "Unpaid")</div>
                </div>
            </div>
        </div>
    </div>

    @* Shows driver plate and name if managed to load, if null show "-" *@
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h6 class="mb-3">Driver</h6>
            <div><b>Driver Plate:</b> @(driverPlate ?? "-")</div>
            <div><b>Driver Name:</b> @(driverName ?? "-")</div>
        </div>
    </div>


    <!-- Feedback -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h6 class="mb-3">Feedback</h6>

            @if (!isAllowed)
            {
                <div class="alert alert-warning mb-0">
                    Feedback is only available for completed rides.
                </div>
            }
            else if (existingFeedback != null)
            {
                <div class="alert alert-success">
                    You already submitted feedback for this ride.
                </div>

                <div class="mb-2">
                    <b>Your Rating:</b> @existingFeedback.Rating @GetStars(existingFeedback.Rating)
                </div>
                <div class="mb-3">
                    <b>Your Comment:</b>
                    @(string.IsNullOrEmpty(existingFeedback.Comment) ? "-" : existingFeedback.Comment)
                </div>
                <div class="text-muted">
                    <b>Submitted:</b>
                    @existingFeedback.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                </div>
            }
            else
            {
                <div class="mb-3" style="max-width: 450px;">
                    <label class="form-label"><b>Rating (1 to 5)</b></label>
                    <select class="form-select" @bind="rating">
                        <option value="5">5⭐⭐⭐⭐⭐ - Excellent</option>
                        <option value="4">4⭐⭐⭐⭐ - Good</option>
                        <option value="3">3⭐⭐⭐ - Okay</option>
                        <option value="2">2⭐⭐ - Bad</option>
                        <option value="1">1⭐ - Terrible</option>
                    </select>
                </div>

                <div class="mb-3" style="max-width: 600px;">
                    <label class="form-label"><b>Comments (optional)</b></label>
                    <textarea class="form-control" rows="4" @bind="comment"></textarea>
                </div>

                <button class="btn btn-dark" @onclick="Submit">Submit</button>
            }
        </div>
    </div>
}

@code {
    // Controls page state, data loading, validation, and feedback submission logic
    //Allows one page to show feedback for many bookings
    [Parameter] public int bookingId { get; set; }

    private bool isLoading = true;
    private string? msg;

    private Booking? booking;

    private string? driverPlate;
    private string? driverName;

    private bool isAllowed = false;

    private int rating = 5;
    private string? comment;

    private string receiptRef = string.Empty;

    private TransportBookFSD.Models.Feedback? existingFeedback;

    //loads booking +driver + feedback from DB.
    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    //Redirects to the booking history page.
    private void Back()
    {
        nav.NavigateTo("/passenger/bookinghistory");
    }


    // Gets the current logged-in user from ASP.NET Identity
    private async Task<ApplicationUser?> GetCurrentUser()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        return await userManager.GetUserAsync(authState.User);
    }

    private async Task Load()
    {
        //Reset UI state before loading.
        isLoading = true;
        msg = null;


        //If identity session not found, show message and stop.
        var user = await GetCurrentUser();
        if (user == null)
        {
            msg = "Please login again.";
            isLoading = false;
            return;
        }

        //Loads booking only if it belongs to the logged-in passenger.
        booking = db.Bookings.FirstOrDefault(b => b.BookingId == bookingId && b.PassengerUserId == user.Id);
        if (booking == null)
        {
            isLoading = false;
            return;
        }

        // Generate receipt reference number
        receiptRef = $"RCP-{booking.PickupDateTime:yyyyMMdd}-{booking.BookingId:D4}";

        //Enables feedback only after ride completion.
        isAllowed = (booking.Status == "Completed");

        //If booking has a driver assigned then load driver’s profile by UserId
        if (!string.IsNullOrWhiteSpace(booking.DriverUserId))
        {
            var d = db.DriverProfiles.FirstOrDefault(x => x.UserId == booking.DriverUserId);
            if (d != null)
            {
                driverPlate = d.VehiclePlate;
                driverName = d.FullName;
            }
        }

        //Checks if a feedback record already exists for this booking.
        existingFeedback = db.Feedbacks.FirstOrDefault(f => f.BookingId == booking.BookingId);

        isLoading = false;
    }


    //Handles Submit button click
    private async Task Submit()
    {
        //Reset message
        msg = null;

        // Prevents null reference crashes
        var user = await GetCurrentUser();
        if (user == null || booking == null)
        {
            msg = "Please login again.";
            return;
        }

        if (booking.Status != "Completed")
        {
            msg = "Feedback is only available for completed rides.";
            return;
        }

        // Prevents duplicate feedback submissions
        var exists = db.Feedbacks.FirstOrDefault(f => f.BookingId == booking.BookingId);
        if (exists != null)
        {
            existingFeedback = exists;
            msg = "You already submitted feedback.";
            return;
        }

        // Create and save new feedback record
        var fb = new TransportBookFSD.Models.Feedback
        {
            BookingId = booking.BookingId,
            PassengerUserId = user.Id,
            DriverUserId = booking.DriverUserId,
            Rating = rating,
            Comment = comment,
            CreatedAt = DateTime.Now
        };

        // Save to database
        db.Feedbacks.Add(fb);
        await db.SaveChangesAsync();

        msg = "Feedback submitted!";
        await Load();
    }


    // Converts numeric rating to star representation
    private string GetStars(int rating)
    {
        return new string('⭐', rating);
    }
}
